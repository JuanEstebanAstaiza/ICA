<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de Administraci√≥n - Sistema ICA">
    <title>Administraci√≥n - Sistema ICA</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Estilos para autocompletado de municipios */
        .municipality-search-container {
            position: relative;
        }
        .municipality-search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
        }
        .municipality-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        .municipality-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .municipality-dropdown.active {
            display: block;
        }
        .municipality-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .municipality-option:hover,
        .municipality-option.highlighted {
            background-color: var(--primary-color);
            color: white;
        }
        .municipality-option .dept {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .municipality-selected {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .municipality-selected .clear-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .municipality-selected .clear-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination-info {
            margin: 0 1rem;
            color: var(--text-muted);
        }
        
        /* Filtro de b√∫squeda para tabla */
        .table-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .table-filter input,
        .table-filter select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            flex: 1;
            min-width: 200px;
        }
        
        /* Configuraci√≥n de consecutivo */
        .serial-config-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed var(--primary-color);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-top: 1rem;
        }
        .serial-preview {
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            background: #2d3748;
            color: #68d391;
            padding: 1rem;
            border-radius: var(--radius);
            margin-top: 0.5rem;
        }
        
        /* Modal de edici√≥n */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-header .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            border-radius: 4px;
            line-height: 1;
        }
        .modal-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* Filas editables */
        #municipalities-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }
        #municipalities-table tbody tr:hover {
            background: #f0f4f8;
        }
        
        /* Sistema de Pesta√±as */
        .admin-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1.5rem;
        }
        .admin-tab {
            padding: 1rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .admin-tab:hover {
            color: var(--primary-color);
            background: rgba(0, 51, 102, 0.05);
        }
        .admin-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(0, 51, 102, 0.08);
        }
        .admin-tab-content {
            display: none;
        }
        .admin-tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <span class="logo-text">Sistema ICA - Admin</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html">Panel Usuario</a></li>
                    <li><a href="admin.html" class="active">Administraci√≥n</a></li>
                    <li><a href="superadmin.html" id="superadmin-link" style="display: none;">Super Admin</a></li>
                </ul>
            </nav>
            
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-outline" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div id="alert-container"></div>
            
            <h1>Panel de Administraci√≥n</h1>
            <p class="text-muted">Configuraci√≥n marca blanca y gesti√≥n del sistema</p>
            
            <!-- Sistema de Pesta√±as -->
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="config" onclick="switchTab('config')">
                    üé® Configuraci√≥n
                </button>
                <button class="admin-tab" data-tab="municipalities" onclick="switchTab('municipalities')">
                    üèõÔ∏è Municipios
                </button>
                <button class="admin-tab" data-tab="forms" onclick="switchTab('forms')">
                    üìã Formularios
                </button>
                <button class="admin-tab" data-tab="backups" onclick="switchTab('backups')">
                    üíæ Backups
                </button>
            </div>
            
            <!-- TAB: Configuraci√≥n -->
            <div id="tab-config" class="admin-tab-content active">
            
            <!-- Acciones r√°pidas -->
            <div class="row" style="margin-top: 1rem; margin-bottom: 1rem;">
                <div class="col-12">
                    <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid var(--primary-color);">
                        <div class="card-body">
                            <div class="d-flex justify-between align-center">
                                <div>
                                    <strong>üëÅÔ∏è Vista Previa del Formulario</strong>
                                    <p class="text-muted mb-0" style="font-size: 0.875rem;">Verifique la estructura de campos del formulario ICA sin necesidad de llenarlo.</p>
                                </div>
                                <a href="form.html?preview=true" class="btn btn-primary">
                                    üëÅÔ∏è Ver Vista Previa
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row" style="margin-top: 2rem;">
                <!-- Configuraci√≥n Marca Blanca -->
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            üé® Configuraci√≥n Marca Blanca
                        </div>
                        <div class="card-body">
                            <form id="white-label-form">
                                <div class="form-group">
                                    <label class="form-label">Municipio</label>
                                    <div class="municipality-search-container">
                                        <input type="text" 
                                               id="wl-municipality-search" 
                                               class="municipality-search-input" 
                                               placeholder="Buscar municipio por nombre..."
                                               autocomplete="off">
                                        <input type="hidden" id="wl-municipality" value="">
                                        <div id="wl-municipality-dropdown" class="municipality-dropdown"></div>
                                    </div>
                                    <div id="wl-municipality-selected" class="municipality-selected" style="display: none;">
                                        <span id="wl-municipality-name"></span>
                                        <button type="button" class="clear-btn" onclick="clearMunicipalitySelection('wl')">‚úï</button>
                                    </div>
                                </div>
                                
                                <!-- Configuraci√≥n de Consecutivo y Radicado -->
                                <div class="serial-config-card">
                                    <h4 style="margin-bottom: 1rem;">üìã Configuraci√≥n de Numeraci√≥n</h4>
                                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                                        <strong>üí° Instrucciones:</strong> Configure el prefijo y el n√∫mero inicial para consecutivos y radicados.
                                        El sistema generar√° autom√°ticamente n√∫meros secuenciales.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-consecutivo-prefijo" class="form-label">Prefijo Consecutivo</label>
                                                <input type="text" id="wl-consecutivo-prefijo" class="form-control" 
                                                       placeholder="" maxlength="10">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-consecutivo-inicio" class="form-label">N√∫mero Inicial</label>
                                                <input type="number" id="wl-consecutivo-inicio" class="form-control" 
                                                       value="1" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-consecutivo-digitos" class="form-label">D√≠gitos (relleno con ceros)</label>
                                                <input type="number" id="wl-consecutivo-digitos" class="form-control" 
                                                       value="12" min="6" max="20">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label class="form-label">Vista Previa Consecutivo</label>
                                                <div class="serial-preview" id="consecutivo-preview">000000000001</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr style="margin: 1rem 0;">
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-radicado-prefijo" class="form-label">Prefijo Radicado</label>
                                                <input type="text" id="wl-radicado-prefijo" class="form-control" 
                                                       placeholder="" maxlength="10">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-radicado-inicio" class="form-label">N√∫mero Inicial</label>
                                                <input type="number" id="wl-radicado-inicio" class="form-control" 
                                                       value="1" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-radicado-digitos" class="form-label">D√≠gitos (relleno con ceros)</label>
                                                <input type="number" id="wl-radicado-digitos" class="form-control" 
                                                       value="16" min="6" max="20">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label class="form-label">Vista Previa Radicado</label>
                                                <div class="serial-preview" id="radicado-preview">0000000000000001</div>
                                             </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-top: 1.5rem;">
                                    <label for="wl-app-name" class="form-label">Nombre de la Aplicaci√≥n</label>
                                    <input type="text" id="wl-app-name" class="form-control" 
                                           value="Sistema ICA"
                                           placeholder="Ej: Alcald√≠a de Medell√≠n - Sistema ICA"
                                           maxlength="255">
                                    <small class="form-text">Este nombre aparecer√° en el encabezado de la aplicaci√≥n web.</small>
                                </div>
                                
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label for="wl-form-title" class="form-label">T√≠tulo del Formulario</label>
                                    <input type="text" id="wl-form-title" class="form-control" 
                                           value="Formulario √önico Nacional de Declaraci√≥n y Pago ICA">
                                </div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="wl-primary-color" class="form-label">Color Primario</label>
                                            <input type="color" id="wl-primary-color" class="form-control" value="#003366">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="wl-secondary-color" class="form-label">Color Secundario</label>
                                            <input type="color" id="wl-secondary-color" class="form-control" value="#0066CC">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="wl-accent-color" class="form-label">Color Acento</label>
                                            <input type="color" id="wl-accent-color" class="form-control" value="#FF9900">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-font" class="form-label">Tipograf√≠a</label>
                                    <select id="wl-font" class="form-control">
                                        <option value="Arial, sans-serif">Arial</option>
                                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                        <option value="Georgia, serif">Georgia</option>
                                        <option value="'Roboto', sans-serif">Roboto</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-header" class="form-label">Texto de Encabezado</label>
                                    <textarea id="wl-header" class="form-control" rows="2" 
                                              placeholder="Texto institucional para el encabezado..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-legal" class="form-label">Notas Legales</label>
                                    <textarea id="wl-legal" class="form-control" rows="3" 
                                              placeholder="Notas legales para el pie del formulario..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-footer" class="form-label">Texto de Pie de P√°gina</label>
                                    <textarea id="wl-footer" class="form-control" rows="2" 
                                              placeholder="Texto para el pie de p√°gina..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-watermark" class="form-label">üîí Marca de Agua (PDF)</label>
                                    <input type="text" id="wl-watermark" class="form-control" 
                                           placeholder="Ej: Alcald√≠a de Medell√≠n - Documento Oficial"
                                           maxlength="255">
                                    <small class="form-text">Este texto aparecer√° como marca de agua diagonal en los PDFs generados para prevenir fraudes.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-logo" class="form-label">Logo Institucional</label>
                                    <input type="file" id="wl-logo" class="form-control" accept="image/*">
                                    <small class="form-text">El logo aparecer√° en el encabezado de la web y en los PDFs generados.</small>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    üíæ Guardar Configuraci√≥n
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Actividades Econ√≥micas -->
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            üìä C√≥digos CIIU - Cat√°logo Nacional
                        </div>
                        <div class="card-body">
                            <!-- Informaci√≥n sobre el cat√°logo -->
                            <div class="alert" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #2563eb; margin-bottom: 1rem;">
                                <strong>üìã Cat√°logo Nacional de C√≥digos CIIU</strong>
                                <p style="font-size: 0.875rem; margin: 0.5rem 0 0;">
                                    Los 504 c√≥digos CIIU de 4 d√≠gitos est√°n precargados del cat√°logo nacional oficial.
                                    Organizados en 22 secciones (A-U). <strong>Solo las tarifas son editables</strong>.
                                </p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Municipio</label>
                                <div class="municipality-search-container">
                                    <input type="text" 
                                           id="act-municipality-search" 
                                           class="municipality-search-input" 
                                           placeholder="Buscar municipio por nombre..."
                                           autocomplete="off">
                                    <input type="hidden" id="act-municipality" value="">
                                    <div id="act-municipality-dropdown" class="municipality-dropdown"></div>
                                </div>
                                <div id="act-municipality-selected" class="municipality-selected" style="display: none;">
                                    <span id="act-municipality-name"></span>
                                    <button type="button" class="clear-btn" onclick="clearMunicipalitySelection('act')">‚úï</button>
                                </div>
                            </div>
                            
                            <!-- Bot√≥n para cargar c√≥digos CIIU -->
                            <div class="alert" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-left: 4px solid #16a34a; margin-bottom: 1rem;">
                                <strong>üì• Cargar C√≥digos CIIU del Cat√°logo Nacional</strong>
                                <p style="font-size: 0.875rem; margin: 0.5rem 0 0.75rem 0;">
                                    Cargue los 504 c√≥digos CIIU del cat√°logo nacional para este municipio.
                                    Los c√≥digos se crear√°n con tarifa 0% - luego configure las tarifas.
                                </p>
                                <button type="button" class="btn btn-primary" onclick="seedCIIUCodesForMunicipality()">
                                    üì• Cargar Cat√°logo Nacional
                                </button>
                            </div>
                            
                            <hr>
                            
                            <h4>C√≥digos CIIU Registrados</h4>
                            
                            <!-- Filtros: Secci√≥n y B√∫squeda -->
                            <div class="row" style="margin-bottom: 1rem;">
                                <div class="col-5">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <select id="activities-section-filter" class="form-control" onchange="filterActivitiesBySection()">
                                            <option value="">üìÅ Todas las secciones</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-7">
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <input type="text" id="activities-search" class="form-control" 
                                               placeholder="üîç Buscar por c√≥digo o descripci√≥n..." 
                                               oninput="searchActivitiesDebounced()">
                                    </div>
                                </div>
                            </div>
                            
                            <table class="table" id="activities-table">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th style="width: 100px;">Secci√≥n</th>
                                        <th style="width: 100px;">Tarifa (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="activities-body">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">
                                            Seleccione un municipio para ver actividades
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Paginaci√≥n de actividades -->
                            <div class="pagination" id="activities-pagination">
                                <button id="act-prev" disabled onclick="goToActivitiesPage(activitiesCurrentPage - 1)">‚Üê Anterior</button>
                                <span class="pagination-info" id="act-page-info">P√°gina 1 de 1</span>
                                <button id="act-next" disabled onclick="goToActivitiesPage(activitiesCurrentPage + 1)">Siguiente ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Par√°metros de F√≥rmulas (Edici√≥n en Caliente) -->
            <div class="row" style="margin-top: 2rem;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            ‚öôÔ∏è Par√°metros de F√≥rmulas (Edici√≥n en Caliente)
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>üìå Nota:</strong> Estos par√°metros permiten ajustar los valores num√©ricos de las f√≥rmulas 
                                del formulario ICA sin necesidad de modificar el c√≥digo. Use esta funcionalidad cuando cambien 
                                las legislaciones municipales.
                            </div>
                            
                            <form id="formula-params-form">
                                <div class="form-group">
                                    <label class="form-label">Municipio</label>
                                    <div class="municipality-search-container">
                                        <input type="text" 
                                               id="fp-municipality-search" 
                                               class="municipality-search-input" 
                                               placeholder="Buscar municipio por nombre..."
                                               autocomplete="off">
                                        <input type="hidden" id="fp-municipality" value="">
                                        <div id="fp-municipality-dropdown" class="municipality-dropdown"></div>
                                    </div>
                                    <div id="fp-municipality-selected" class="municipality-selected" style="display: none;">
                                        <span id="fp-municipality-name"></span>
                                        <button type="button" class="clear-btn" onclick="clearMunicipalitySelection('fp')">‚úï</button>
                                    </div>
                                </div>
                                
                                <div class="section-title" style="margin-top: 1.5rem;">Secci√≥n D - Liquidaci√≥n del Impuesto</div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-avisos-tableros" class="form-label">
                                                Avisos y Tableros (% sobre ICA)
                                                <small class="text-muted">Rengl√≥n 21</small>
                                            </label>
                                            <input type="number" id="fp-avisos-tableros" class="form-control" 
                                                   min="0" max="100" step="0.1" value="15">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-sobretasa-bomberil" class="form-label">
                                                Sobretasa Bomberil (%)
                                                <small class="text-muted">Rengl√≥n 23</small>
                                            </label>
                                            <input type="number" id="fp-sobretasa-bomberil" class="form-control" 
                                                   min="0" max="100" step="0.1" value="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-sobretasa-seguridad" class="form-label">
                                                Sobretasa Seguridad (%)
                                                <small class="text-muted">Rengl√≥n 24</small>
                                            </label>
                                            <input type="number" id="fp-sobretasa-seguridad" class="form-control" 
                                                   min="0" max="100" step="0.1" value="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-ley56-tarifa" class="form-label">
                                                Ley 56/1981 - Tarifa por kW
                                                <small class="text-muted">Rengl√≥n 19</small>
                                            </label>
                                            <input type="number" id="fp-ley56-tarifa" class="form-control" 
                                                   min="0" step="0.01" value="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-unidades-financiero" class="form-label">
                                                Unidades Adicionales Financiero
                                                <small class="text-muted">Rengl√≥n 22</small>
                                            </label>
                                            <input type="number" id="fp-unidades-financiero" class="form-control" 
                                                   min="0" step="0.01" value="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-anticipo" class="form-label">
                                                Anticipo A√±o Siguiente (%)
                                                <small class="text-muted">Rengl√≥n 30</small>
                                            </label>
                                            <input type="number" id="fp-anticipo" class="form-control" 
                                                   min="0" max="100" step="0.1" value="40">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="section-title" style="margin-top: 1.5rem;">Secci√≥n E - Pago</div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-descuento-pronto-pago" class="form-label">
                                                Descuento Pronto Pago (%)
                                                <small class="text-muted">Rengl√≥n 36</small>
                                            </label>
                                            <input type="number" id="fp-descuento-pronto-pago" class="form-control" 
                                                   min="0" max="100" step="0.1" value="10">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-descuento-dias" class="form-label">
                                                D√≠as para Descuento
                                                <small class="text-muted">D√≠as l√≠mite</small>
                                            </label>
                                            <input type="number" id="fp-descuento-dias" class="form-control" 
                                                   min="0" value="30">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-interes-mora" class="form-label">
                                                Inter√©s Mora Mensual (%)
                                                <small class="text-muted">Rengl√≥n 37</small>
                                            </label>
                                            <input type="number" id="fp-interes-mora" class="form-control" 
                                                   min="0" max="100" step="0.01" value="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">
                                    üíæ Guardar Par√°metros de F√≥rmulas
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            </div><!-- Fin TAB: Configuraci√≥n -->
            
            <!-- TAB: Municipios -->
            <div id="tab-municipalities" class="admin-tab-content">
            
            <!-- Gesti√≥n de Municipios con Paginaci√≥n -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            üèõÔ∏è Gesti√≥n de Municipios
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>üìå Nota:</strong> Haga doble clic sobre cualquier municipio para editar su c√≥digo DANE 
                                en caso de que no coincida con el c√≥digo oficial publicado por el DANE.
                            </div>
                            
                            <!-- Filtros de b√∫squeda -->
                            <div class="table-filter">
                                <input type="text" id="muni-filter-search" placeholder="üîç Buscar por nombre o c√≥digo...">
                                <select id="muni-filter-dept">
                                    <option value="">Todos los departamentos</option>
                                </select>
                            </div>
                            
                            <table class="table" id="municipalities-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo DANE</th>
                                        <th>Municipio</th>
                                        <th>Departamento</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="municipalities-body">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">
                                            Cargando municipios...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Paginaci√≥n -->
                            <div class="pagination" id="municipalities-pagination">
                                <button id="muni-prev" disabled>‚Üê Anterior</button>
                                <span class="pagination-info" id="muni-page-info">P√°gina 1 de 1</span>
                                <button id="muni-next" disabled>Siguiente ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal de Edici√≥n de Municipio -->
            <div id="edit-municipality-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Municipio</h3>
                        <button type="button" class="close-btn" onclick="closeEditMunicipalityModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-municipality-form">
                            <input type="hidden" id="edit-muni-id">
                            <div class="form-group">
                                <label for="edit-muni-code" class="form-label">C√≥digo DANE</label>
                                <input type="text" id="edit-muni-code" class="form-control" required>
                                <small class="text-muted">Modifique este c√≥digo solo si no coincide con el oficial del DANE</small>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="edit-muni-name" class="form-label">Nombre del Municipio</label>
                                <input type="text" id="edit-muni-name" class="form-control" readonly>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="edit-muni-dept" class="form-label">Departamento</label>
                                <input type="text" id="edit-muni-dept" class="form-control" readonly>
                            </div>
                            <div class="modal-footer" style="margin-top: 1.5rem;">
                                <button type="button" class="btn btn-secondary" onclick="closeEditMunicipalityModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        </div><!-- Fin TAB: Municipios -->
        
        <!-- TAB: Formularios -->
        <div id="tab-forms" class="admin-tab-content">
        
        <!-- Panel de Gesti√≥n de Formularios -->
        <div class="row" id="forms-management-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #059669, #047857); color: white;">
                        üìã Gesti√≥n de Formularios Radicados
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <strong>üîç B√∫squeda de Declaraciones:</strong> Busque formularios por n√∫mero de radicado, 
                            n√∫mero de formulario o documento del contribuyente.
                        </div>
                        
                        <!-- Barra de b√∫squeda -->
                        <div class="row mb-3">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="search-filing-number" class="form-label">No. Radicado</label>
                                    <input type="text" id="search-filing-number" class="form-control" 
                                           placeholder="Buscar por radicado...">
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="search-form-number" class="form-label">No. Formulario</label>
                                    <input type="text" id="search-form-number" class="form-control" 
                                           placeholder="Buscar por formulario...">
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="search-document" class="form-label">Documento</label>
                                    <input type="text" id="search-document" class="form-control" 
                                           placeholder="Documento contribuyente...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" onclick="searchDeclarations()">
                                    üîç Buscar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadAllDeclarations()">
                                    üìã Ver Todos
                                </button>
                            </div>
                        </div>
                        
                        <!-- Tabla de resultados -->
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-hover">
                                <thead style="position: sticky; top: 0; background: white;">
                                    <tr>
                                        <th>No. Radicado</th>
                                        <th>No. Formulario</th>
                                        <th>Contribuyente</th>
                                        <th>Documento</th>
                                        <th>A√±o</th>
                                        <th>Estado</th>
                                        <th>Fecha Radicado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="declarations-results">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            Use los filtros de b√∫squeda o haga clic en "Ver Todos"
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Estad√≠sticas -->
                        <div id="declarations-stats" class="mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-3">
                                    <div class="stat-card" style="background: #dbeafe; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold;" id="stat-forms-total">0</div>
                                        <div style="font-size: 0.875rem; color: #1e40af;">Total</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-card" style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold;" id="stat-forms-signed">0</div>
                                        <div style="font-size: 0.875rem; color: #166534;">Firmados</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-card" style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold;" id="stat-forms-draft">0</div>
                                        <div style="font-size: 0.875rem; color: #92400e;">Borradores</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-card" style="background: #f3e8ff; padding: 1rem; border-radius: 0.5rem; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: bold;" id="stat-forms-corrections">0</div>
                                        <div style="font-size: 0.875rem; color: #7c3aed;">Correcciones</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Paginaci√≥n -->
                        <div id="declarations-pagination" class="pagination" style="margin-top: 1rem;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        </div><!-- Fin TAB: Formularios -->
        
        <!-- TAB: Backups -->
        <div id="tab-backups" class="admin-tab-content">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white;">
                            üíæ Gesti√≥n de Backups
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>üìå Informaci√≥n:</strong> Los backups permiten crear copias de seguridad de los datos 
                                del sistema. Se recomienda crear backups peri√≥dicos para garantizar la persistencia de la informaci√≥n.
                            </div>
                            
                            <!-- Acciones de backup -->
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" class="btn btn-primary" onclick="createBackup()">
                                    ‚ûï Crear Backup
                                </button>
                                <label class="btn btn-secondary" style="cursor: pointer;">
                                    üì§ Subir Backup
                                    <input type="file" id="backup-file-upload" accept=".sql,.json" style="display: none;" onchange="uploadBackupFile(this)">
                                </label>
                                <button type="button" class="btn btn-ghost" onclick="loadBackupsList()">
                                    üîÑ Actualizar Lista
                                </button>
                            </div>
                            
                            <!-- Lista de backups -->
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nombre del Archivo</th>
                                            <th>Tipo</th>
                                            <th>Tama√±o</th>
                                            <th>Fecha de Creaci√≥n</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backups-list">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                Cargando backups...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Informaci√≥n adicional -->
                            <div class="alert" style="margin-top: 1rem; background: #d1fae5; border-left: 4px solid #10b981;">
                                <strong>‚úÖ Backups Hotswap (JSON):</strong>
                                <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                                    <li>Los backups JSON son <strong>completos</strong> y pueden restaurarse sin intervenci√≥n t√©cnica.</li>
                                    <li>Use el bot√≥n üîÑ para restaurar declaraciones directamente desde la interfaz.</li>
                                    <li>La restauraci√≥n <strong>NO sobrescribe</strong> declaraciones existentes.</li>
                                    <li>Incluyen: declaraciones, contribuyentes, actividades, liquidaci√≥n y firmas.</li>
                                </ul>
                            </div>
                            
                            <div class="alert" style="margin-top: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b;">
                                <strong>‚ö†Ô∏è Backups SQL:</strong>
                                <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                                    <li>Los backups SQL contienen toda la informaci√≥n de la base de datos.</li>
                                    <li>Para restaurar un backup SQL, contacte al administrador del sistema.</li>
                                    <li>Se recomienda mantener al menos 3 backups recientes.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- Fin TAB: Backups -->
        
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema ICA - Panel de Administraci√≥n</p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script src="../js/api.js"></script>
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let allMunicipalities = [];
        let filteredMunicipalities = [];
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        
        // Municipio seleccionado guardado en localStorage
        let selectedMunicipality = JSON.parse(localStorage.getItem('selectedMunicipality') || 'null');
        
        // ==================== VERIFICAR AUTENTICACI√ìN ====================
        if (!AuthAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // Variable para controlar si el usuario tiene municipio fijo
        let userHasFixedMunicipality = false;
        let currentUserData = null;
        
        // ==================== FUNCIONES DE MUNICIPIOS ====================
        
        // Cargar todos los municipios
        async function loadMunicipalities() {
            try {
                allMunicipalities = await AdminAPI.listMunicipalities();
                filteredMunicipalities = [...allMunicipalities];
                
                // Llenar filtro de departamentos
                fillDepartmentFilter();
                
                // Renderizar tabla paginada
                renderMunicipalitiesTable();
                
                // Inicializar buscadores de municipios
                initMunicipalitySearchers();
                
                // Restaurar municipio seleccionado si existe
                if (selectedMunicipality) {
                    restoreSelectedMunicipality();
                }
            } catch (error) {
                console.error('Error loading municipalities:', error);
            }
        }
        
        // Llenar filtro de departamentos
        function fillDepartmentFilter() {
            const departments = [...new Set(allMunicipalities.map(m => m.department))].sort();
            const select = document.getElementById('muni-filter-dept');
            select.innerHTML = '<option value="">Todos los departamentos</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }
        
        // Filtrar municipios
        function filterMunicipalities() {
            const searchTerm = document.getElementById('muni-filter-search').value.toLowerCase();
            const deptFilter = document.getElementById('muni-filter-dept').value;
            
            filteredMunicipalities = allMunicipalities.filter(m => {
                const matchesSearch = !searchTerm || 
                    m.name.toLowerCase().includes(searchTerm) || 
                    m.code.includes(searchTerm);
                const matchesDept = !deptFilter || m.department === deptFilter;
                return matchesSearch && matchesDept;
            });
            
            currentPage = 1;
            renderMunicipalitiesTable();
        }
        
        // Renderizar tabla de municipios con paginaci√≥n
        function renderMunicipalitiesTable() {
            const tbody = document.getElementById('municipalities-body');
            const totalPages = Math.ceil(filteredMunicipalities.length / ITEMS_PER_PAGE);
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = filteredMunicipalities.slice(start, end);
            
            if (filteredMunicipalities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No se encontraron municipios</td></tr>';
            } else {
                tbody.innerHTML = pageData.map(m => `
                    <tr ondblclick="openEditMunicipalityModal(${m.id}, '${m.code}', '${m.name.replace(/'/g, "\\'")}', '${m.department.replace(/'/g, "\\'")}')">
                        <td><strong>${m.code}</strong></td>
                        <td>${m.name}</td>
                        <td>${m.department}</td>
                        <td>
                            <span class="badge ${m.is_active ? 'badge-firmado' : 'badge-anulado'}">
                                ${m.is_active ? 'ACTIVO' : 'INACTIVO'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Actualizar paginaci√≥n
            document.getElementById('muni-page-info').textContent = 
                `P√°gina ${currentPage} de ${totalPages || 1} (${filteredMunicipalities.length} municipios)`;
            document.getElementById('muni-prev').disabled = currentPage <= 1;
            document.getElementById('muni-next').disabled = currentPage >= totalPages;
        }
        
        // ==================== MODAL DE EDICI√ìN DE MUNICIPIO ====================
        
        function openEditMunicipalityModal(id, code, name, department) {
            document.getElementById('edit-muni-id').value = id;
            document.getElementById('edit-muni-code').value = code;
            document.getElementById('edit-muni-name').value = name;
            document.getElementById('edit-muni-dept').value = department;
            document.getElementById('edit-municipality-modal').style.display = 'flex';
        }
        
        function closeEditMunicipalityModal() {
            document.getElementById('edit-municipality-modal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('edit-municipality-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditMunicipalityModal();
            }
        });
        
        // Formulario de edici√≥n de municipio
        document.getElementById('edit-municipality-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-muni-id').value;
            const code = document.getElementById('edit-muni-code').value;
            const name = document.getElementById('edit-muni-name').value;
            const department = document.getElementById('edit-muni-dept').value;
            
            try {
                showLoading();
                
                await AdminAPI.updateMunicipality(id, {
                    code: code,
                    name: name,
                    department: department
                });
                
                closeEditMunicipalityModal();
                await loadMunicipalities();
                
                hideLoading();
                alert('‚úÖ C√≥digo DANE actualizado correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // ==================== BUSCADOR DE MUNICIPIOS (AUTOCOMPLETE) ====================
        
        function initMunicipalitySearchers() {
            const searchConfigs = [
                { prefix: 'wl', onSelect: loadWhiteLabelConfig },
                { prefix: 'act', onSelect: (id) => { loadCIIUSections(id); loadActivities(id, 1, '', ''); } },
                { prefix: 'fp', onSelect: loadFormulaParameters }
            ];
            
            searchConfigs.forEach(config => {
                const input = document.getElementById(`${config.prefix}-municipality-search`);
                const dropdown = document.getElementById(`${config.prefix}-municipality-dropdown`);
                const hiddenInput = document.getElementById(`${config.prefix}-municipality`);
                
                if (!input || !dropdown) return;
                
                // Evento de escritura
                input.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    if (searchTerm.length < 1) {
                        dropdown.classList.remove('active');
                        return;
                    }
                    
                    const matches = allMunicipalities.filter(m => 
                        m.name.toLowerCase().includes(searchTerm) || 
                        m.department.toLowerCase().includes(searchTerm) ||
                        m.code.includes(searchTerm)
                    ).slice(0, 10);
                    
                    if (matches.length > 0) {
                        dropdown.innerHTML = matches.map(m => `
                            <div class="municipality-option" data-id="${m.id}" data-name="${m.name}" data-dept="${m.department}">
                                <strong>${m.name}</strong>
                                <span class="dept">(${m.department} - ${m.code})</span>
                            </div>
                        `).join('');
                        dropdown.classList.add('active');
                        
                        // Eventos de click en opciones
                        dropdown.querySelectorAll('.municipality-option').forEach(opt => {
                            opt.addEventListener('click', () => {
                                const id = opt.dataset.id;
                                const name = opt.dataset.name;
                                const dept = opt.dataset.dept;
                                
                                selectMunicipality(config.prefix, id, name, dept);
                                dropdown.classList.remove('active');
                                input.value = '';
                                
                                // Ejecutar callback
                                if (config.onSelect) {
                                    config.onSelect(id);
                                }
                            });
                        });
                    } else {
                        dropdown.innerHTML = '<div class="municipality-option">No se encontraron resultados</div>';
                        dropdown.classList.add('active');
                    }
                });
                
                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
                
                // Navegaci√≥n con teclado
                input.addEventListener('keydown', (e) => {
                    const options = dropdown.querySelectorAll('.municipality-option');
                    const highlighted = dropdown.querySelector('.municipality-option.highlighted');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (highlighted) {
                            highlighted.classList.remove('highlighted');
                            const next = highlighted.nextElementSibling;
                            if (next) next.classList.add('highlighted');
                            else options[0]?.classList.add('highlighted');
                        } else {
                            options[0]?.classList.add('highlighted');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (highlighted) {
                            highlighted.classList.remove('highlighted');
                            const prev = highlighted.previousElementSibling;
                            if (prev) prev.classList.add('highlighted');
                            else options[options.length - 1]?.classList.add('highlighted');
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (highlighted) {
                            highlighted.click();
                        }
                    }
                });
            });
        }
        
        function selectMunicipality(prefix, id, name, dept) {
            document.getElementById(`${prefix}-municipality`).value = id;
            document.getElementById(`${prefix}-municipality-name`).textContent = `${name} - ${dept}`;
            document.getElementById(`${prefix}-municipality-selected`).style.display = 'flex';
            
            // Guardar selecci√≥n en localStorage
            selectedMunicipality = { id, name, dept };
            localStorage.setItem('selectedMunicipality', JSON.stringify(selectedMunicipality));
            
            // Sincronizar todos los selectores
            syncMunicipalitySelectors(prefix);
        }
        
        function clearMunicipalitySelection(prefix) {
            // No permitir limpiar si el usuario tiene municipio fijo
            if (userHasFixedMunicipality) {
                return;
            }
            
            document.getElementById(`${prefix}-municipality`).value = '';
            document.getElementById(`${prefix}-municipality-selected`).style.display = 'none';
            document.getElementById(`${prefix}-municipality-search`).value = '';
        }
        
        function syncMunicipalitySelectors(sourcePrefix) {
            const prefixes = ['wl', 'act', 'fp'];
            prefixes.forEach(prefix => {
                if (prefix !== sourcePrefix && selectedMunicipality) {
                    document.getElementById(`${prefix}-municipality`).value = selectedMunicipality.id;
                    document.getElementById(`${prefix}-municipality-name`).textContent = 
                        `${selectedMunicipality.name} - ${selectedMunicipality.dept}`;
                    document.getElementById(`${prefix}-municipality-selected`).style.display = 'flex';
                }
            });
        }
        
        function restoreSelectedMunicipality() {
            // Si tiene municipio fijo, no restaurar desde localStorage
            if (userHasFixedMunicipality) {
                return;
            }
            
            const prefixes = ['wl', 'act', 'fp'];
            prefixes.forEach(prefix => {
                document.getElementById(`${prefix}-municipality`).value = selectedMunicipality.id;
                document.getElementById(`${prefix}-municipality-name`).textContent = 
                    `${selectedMunicipality.name} - ${selectedMunicipality.dept}`;
                document.getElementById(`${prefix}-municipality-selected`).style.display = 'flex';
            });
            
            // Cargar datos del municipio seleccionado
            loadWhiteLabelConfig(selectedMunicipality.id);
            loadCIIUSections(selectedMunicipality.id);
            loadActivities(selectedMunicipality.id, 1, '', '');
            loadFormulaParameters(selectedMunicipality.id);
        }
        
        // ==================== VISTA PREVIA DE CONSECUTIVO/RADICADO ====================
        
        function updateSerialPreview() {
            const consecutivoPrefijo = document.getElementById('wl-consecutivo-prefijo').value;
            const consecutivoInicio = parseInt(document.getElementById('wl-consecutivo-inicio').value) || 1;
            const consecutivoDigitos = parseInt(document.getElementById('wl-consecutivo-digitos').value) || 12;
            
            const radicadoPrefijo = document.getElementById('wl-radicado-prefijo').value;
            const radicadoInicio = parseInt(document.getElementById('wl-radicado-inicio').value) || 1;
            const radicadoDigitos = parseInt(document.getElementById('wl-radicado-digitos').value) || 16;
            
            const consecutivoNum = consecutivoInicio.toString().padStart(consecutivoDigitos, '0');
            const radicadoNum = radicadoInicio.toString().padStart(radicadoDigitos, '0');
            
            document.getElementById('consecutivo-preview').textContent = consecutivoPrefijo + consecutivoNum;
            document.getElementById('radicado-preview').textContent = radicadoPrefijo + radicadoNum;
        }
        
        // Event listeners para vista previa
        ['wl-consecutivo-prefijo', 'wl-consecutivo-inicio', 'wl-consecutivo-digitos',
         'wl-radicado-prefijo', 'wl-radicado-inicio', 'wl-radicado-digitos'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateSerialPreview);
        });
        
        // ==================== FUNCIONES DE CARGA DE DATOS ====================
        
        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                currentUserData = user;
                document.getElementById('user-name').textContent = user.full_name;
                
                if (user.role !== 'admin_alcaldia' && user.role !== 'admin_sistema') {
                    alert('No tiene permisos para acceder a esta p√°gina');
                    window.location.href = 'dashboard.html';
                }
                
                // Mostrar link de super admin solo para admin_sistema
                if (user.role === 'admin_sistema') {
                    document.getElementById('superadmin-link').style.display = 'inline';
                }
                
                // Si es ADMIN_ALCALDIA con municipio asignado, bloquear los selectores
                if (user.role === 'admin_alcaldia' && user.municipality_id) {
                    userHasFixedMunicipality = true;
                    
                    // Esperar a que carguen los municipios para configurar la selecci√≥n fija
                    setTimeout(() => {
                        setupFixedMunicipality(user);
                    }, 500);
                }
                
                // Configurar secci√≥n de gesti√≥n de formularios
                setupFormManagementSection(user);
                
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        
        // Configurar municipio fijo para ADMIN_ALCALDIA
        function setupFixedMunicipality(user) {
            // Buscar el municipio del usuario - first check if it's in user.municipality (from API)
            // Otherwise try to find from allMunicipalities
            let municipality = user.municipality;
            
            if (!municipality && user.municipality_id) {
                municipality = allMunicipalities.find(m => m.id === user.municipality_id);
            }
            
            if (!municipality) {
                console.error('Municipio del usuario no encontrado. municipality_id:', user.municipality_id);
                // Show error message to user
                const alertContainer = document.getElementById('alert-container');
                alertContainer.innerHTML = `
                    <div class="alert alert-warning" style="margin-bottom: 1rem;">
                        <strong>‚ö†Ô∏è Advertencia:</strong> No se pudo cargar la informaci√≥n del municipio asociado a su cuenta.
                        Por favor, contacte al administrador del sistema.
                    </div>
                `;
                return;
            }
            
            const prefixes = ['wl', 'act', 'fp'];
            
            prefixes.forEach(prefix => {
                // Ocultar el buscador
                const searchContainer = document.querySelector(`#${prefix}-municipality-search`)?.closest('.municipality-search-container');
                if (searchContainer) {
                    searchContainer.style.display = 'none';
                }
                
                // Configurar el valor oculto
                document.getElementById(`${prefix}-municipality`).value = municipality.id;
                
                // Mostrar el municipio seleccionado (bloqueado)
                const selectedDiv = document.getElementById(`${prefix}-municipality-selected`);
                const nameSpan = document.getElementById(`${prefix}-municipality-name`);
                
                if (selectedDiv && nameSpan) {
                    nameSpan.innerHTML = `<strong>üîí ${municipality.name}</strong> - ${municipality.department} (Asignado a su cuenta)`;
                    selectedDiv.style.display = 'flex';
                    selectedDiv.style.background = 'linear-gradient(135deg, #2d3748, #1a202c)';
                    
                    // Remover el bot√≥n de limpiar
                    const clearBtn = selectedDiv.querySelector('.clear-btn');
                    if (clearBtn) {
                        clearBtn.style.display = 'none';
                    }
                }
            });
            
            // Guardar en localStorage y cargar datos
            selectedMunicipality = { 
                id: municipality.id, 
                name: municipality.name, 
                dept: municipality.department 
            };
            localStorage.setItem('selectedMunicipality', JSON.stringify(selectedMunicipality));
            
            // Cargar datos del municipio
            loadWhiteLabelConfig(municipality.id);
            loadCIIUSections(municipality.id);
            loadActivities(municipality.id, 1, '', '');
            loadFormulaParameters(municipality.id);
            
            // Mostrar mensaje informativo
            const alertContainer = document.getElementById('alert-container');
            alertContainer.innerHTML = `
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Como administrador de alcald√≠a, solo puede configurar el municipio 
                    <strong>${municipality.name}, ${municipality.department}</strong> que fue asignado a su cuenta.
                </div>
            `;
        }
        
        async function loadWhiteLabelConfig(municipalityId) {
            if (!municipalityId) return;
            
            try {
                const config = await AdminAPI.getWhiteLabelConfig(municipalityId);
                
                document.getElementById('wl-app-name').value = config.app_name || 'Sistema ICA';
                document.getElementById('wl-form-title').value = config.form_title || '';
                document.getElementById('wl-primary-color').value = config.primary_color || '#003366';
                document.getElementById('wl-secondary-color').value = config.secondary_color || '#0066CC';
                document.getElementById('wl-accent-color').value = config.accent_color || '#FF9900';
                document.getElementById('wl-font').value = config.font_family || 'Arial, sans-serif';
                document.getElementById('wl-header').value = config.header_text || '';
                document.getElementById('wl-legal').value = config.legal_notes || '';
                document.getElementById('wl-footer').value = config.footer_text || '';
                document.getElementById('wl-watermark').value = config.watermark_text || '';
                
                // Cargar configuraci√≥n de consecutivo y radicado
                document.getElementById('wl-consecutivo-prefijo').value = config.consecutivo_prefijo || '';
                document.getElementById('wl-consecutivo-inicio').value = config.consecutivo_actual || 1;
                document.getElementById('wl-consecutivo-digitos').value = config.consecutivo_digitos || 12;
                document.getElementById('wl-radicado-prefijo').value = config.radicado_prefijo || '';
                document.getElementById('wl-radicado-inicio').value = config.radicado_actual || 1;
                document.getElementById('wl-radicado-digitos').value = config.radicado_digitos || 16;
                
                updateSerialPreview();
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        // ==================== C√ìDIGOS CIIU - CAT√ÅLOGO NACIONAL ====================
        
        const ACTIVITIES_PER_PAGE = 10;
        let activitiesCurrentPage = 1;
        let activitiesSearchTerm = '';
        let activitiesSectionFilter = '';
        let searchDebounceTimer = null;
        
        // Cargar secciones CIIU disponibles para el municipio
        async function loadCIIUSections(municipalityId) {
            const sectionSelect = document.getElementById('activities-section-filter');
            
            if (!municipalityId) {
                sectionSelect.innerHTML = '<option value="">üìÅ Todas las secciones</option>';
                return;
            }
            
            try {
                const sections = await AdminAPI.listCIIUSections(municipalityId);
                
                sectionSelect.innerHTML = '<option value="">üìÅ Todas las secciones</option>';
                sections.forEach(s => {
                    // Extract section identifier - handles both "SECCI√ìN A" and "SECCI√ìN Dian"
                    let letter = '';
                    if (s.section_code) {
                        letter = s.section_code.replace('SECCI√ìN ', '').trim();
                        // Truncate if longer than 4 chars (e.g., "Dian")
                        if (letter.length > 4) letter = letter.substring(0, 4);
                    }
                    const option = document.createElement('option');
                    option.value = s.section_code || '';
                    const sectionNameDisplay = s.section_name ? s.section_name.substring(0, 40) + (s.section_name.length > 40 ? '...' : '') : '';
                    option.textContent = `${letter}: ${sectionNameDisplay}`;
                    sectionSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading CIIU sections:', error);
            }
        }
        
        // Filtrar por secci√≥n
        function filterActivitiesBySection() {
            activitiesSectionFilter = document.getElementById('activities-section-filter').value;
            const municipalityId = document.getElementById('act-municipality').value;
            if (municipalityId) {
                loadActivities(municipalityId, 1, activitiesSearchTerm, activitiesSectionFilter);
            }
        }
        
        // Cargar c√≥digos CIIU del cat√°logo nacional
        async function seedCIIUCodesForMunicipality() {
            const municipalityId = document.getElementById('act-municipality').value;
            if (!municipalityId) {
                showAlert('‚ö†Ô∏è Primero seleccione un municipio', 'warning');
                return;
            }
            
            if (!confirm('¬øDesea cargar los 504 c√≥digos CIIU del cat√°logo nacional para este municipio?\n\nLos c√≥digos se crear√°n con tarifa 0%. Luego deber√° configurar las tarifas.')) {
                return;
            }
            
            try {
                showLoading();
                const result = await AdminAPI.seedCIIUCodes(municipalityId);
                hideLoading();
                
                let message = `‚úÖ ${result.message}\n\n`;
                message += `üìä C√≥digos creados: ${result.created_count}\n`;
                message += `üîÑ C√≥digos actualizados: ${result.updated_count}\n`;
                message += `‚è≠Ô∏è C√≥digos existentes: ${result.existing_count}\n`;
                message += `üìö Total en cat√°logo: ${result.total_catalog}`;
                
                showAlert(message, 'success');
                
                // Recargar actividades y secciones
                loadCIIUSections(municipalityId);
                loadActivities(municipalityId, 1, '', '');
                document.getElementById('activities-search').value = '';
                document.getElementById('activities-section-filter').value = '';
                activitiesSearchTerm = '';
                activitiesSectionFilter = '';
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al cargar c√≥digos CIIU: ' + error.message, 'danger');
            }
        }
        
        async function loadActivities(municipalityId, page = 1, search = '', section = '') {
            if (!municipalityId) {
                document.getElementById('activities-body').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center;">Seleccione un municipio</td></tr>';
                updateActivitiesPagination(0, 1, 1);
                return;
            }
            
            activitiesCurrentPage = page;
            activitiesSearchTerm = search;
            activitiesSectionFilter = section;
            
            try {
                const result = await AdminAPI.listActivitiesPaginated(municipalityId, page, ACTIVITIES_PER_PAGE, search, section);
                const tbody = document.getElementById('activities-body');
                
                if (result.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay c√≥digos CIIU registrados. Use "Cargar Cat√°logo Nacional" para cargarlos.</td></tr>';
                } else {
                    tbody.innerHTML = result.items.map(a => {
                        // Extract section letter, handle special cases like "SECCI√ìN Dian"
                        let sectionLetter = '-';
                        if (a.section_code) {
                            sectionLetter = a.section_code.replace('SECCI√ìN ', '').trim();
                            // Truncate if longer than 4 chars
                            if (sectionLetter.length > 4) sectionLetter = sectionLetter.substring(0, 4);
                        }
                        // Safely handle null/undefined description
                        const desc = a.description || '';
                        const descShort = desc.substring(0, 50) + (desc.length > 50 ? '...' : '');
                        return `
                            <tr>
                                <td><strong>${escapeHtml(a.ciiu_code || '')}</strong></td>
                                <td title="${escapeHtml(desc)}">${escapeHtml(descShort)}</td>
                                <td><span class="badge" style="background: #e5e7eb; color: #374151; font-size: 0.75rem;">${escapeHtml(sectionLetter)}</span></td>
                                <td>
                                    <input type="number" class="form-control tax-rate-input" 
                                           data-id="${a.id}"
                                           data-ciiu="${escapeHtml(a.ciiu_code || '')}"
                                           value="${a.tax_rate || 0}" 
                                           min="0" max="100" step="0.01"
                                           style="width: 80px; padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                                           onchange="updateTaxRate(this)">
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                updateActivitiesPagination(result.total, result.page, result.total_pages);
            } catch (error) {
                console.error('Error loading activities:', error);
                document.getElementById('activities-body').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center; color: red;">Error al cargar actividades</td></tr>';
            }
        }
        
        // Actualizar tarifa de una actividad
        async function updateTaxRate(input) {
            const activityId = parseInt(input.dataset.id);
            const ciiuCode = input.dataset.ciiu;
            const newRate = parseFloat(input.value);
            
            if (isNaN(newRate) || newRate < 0 || newRate > 100) {
                showAlert('‚ùå La tarifa debe ser un n√∫mero entre 0 y 100', 'danger');
                return;
            }
            
            try {
                await AdminAPI.updateActivityTaxRate(activityId, newRate);
                showAlert(`‚úÖ Tarifa del c√≥digo ${ciiuCode} actualizada a ${newRate}%`, 'success');
            } catch (error) {
                showAlert('‚ùå Error al actualizar tarifa: ' + error.message, 'danger');
            }
        }
        
        function updateActivitiesPagination(total, currentPage, totalPages) {
            document.getElementById('act-page-info').textContent = 
                `P√°gina ${currentPage} de ${totalPages || 1} (${total} c√≥digos)`;
            document.getElementById('act-prev').disabled = currentPage <= 1;
            document.getElementById('act-next').disabled = currentPage >= totalPages;
        }
        
        function goToActivitiesPage(page) {
            const municipalityId = document.getElementById('act-municipality').value;
            if (municipalityId) {
                loadActivities(municipalityId, page, activitiesSearchTerm, activitiesSectionFilter);
            }
        }
        
        function searchActivitiesDebounced() {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                const searchTerm = document.getElementById('activities-search').value;
                const municipalityId = document.getElementById('act-municipality').value;
                if (municipalityId) {
                    loadActivities(municipalityId, 1, searchTerm, activitiesSectionFilter);
                }
            }, 300);
        }
        
        // Funci√≥n auxiliar para escapar HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== (Funciones removidas - CSV upload no disponible) ====================
        // Los c√≥digos CIIU ahora se cargan desde el cat√°logo nacional usando seedCIIUCodesForMunicipality()
        
        // Funci√≥n legado para editar actividad (ahora solo edita tarifa)
        function editActivity(id, ciiu_code, description, tax_rate) {
            const newRate = prompt(`Editar tarifa para c√≥digo ${ciiu_code}:\n${description}\n\nTarifa actual: ${tax_rate}%\n\nIngrese nueva tarifa (0-100):`, tax_rate);
            if (newRate === null) return;
            
            const rate = parseFloat(newRate);
            if (isNaN(rate) || rate < 0 || rate > 100) {
                showAlert('‚ùå La tarifa debe ser un n√∫mero entre 0 y 100', 'danger');
                return;
            }
            
            updateTaxRateAsync(id, ciiu_code, rate);
        }
        
        async function updateTaxRateAsync(id, ciiu_code, rate) {
            try {
                showLoading();
                await AdminAPI.updateActivityTaxRate(id, rate);
                hideLoading();
                showAlert(`‚úÖ Tarifa del c√≥digo ${ciiu_code} actualizada a ${rate}%`, 'success');
                
                const municipalityId = document.getElementById('act-municipality').value;
                loadActivities(municipalityId, activitiesCurrentPage, activitiesSearchTerm, activitiesSectionFilter);
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al actualizar: ' + error.message, 'danger');
            }
        }
        
        async function loadFormulaParameters(municipalityId) {
            if (!municipalityId) return;
            
            try {
                const params = await AdminAPI.getFormulaParameters(municipalityId);
                
                document.getElementById('fp-avisos-tableros').value = params.avisos_tableros_porcentaje || 15;
                document.getElementById('fp-sobretasa-bomberil').value = params.sobretasa_bomberil_porcentaje || 0;
                document.getElementById('fp-sobretasa-seguridad').value = params.sobretasa_seguridad_porcentaje || 0;
                document.getElementById('fp-ley56-tarifa').value = params.ley_56_tarifa_por_kw || 0;
                document.getElementById('fp-unidades-financiero').value = params.unidades_adicionales_financiero_valor || 0;
                document.getElementById('fp-anticipo').value = params.anticipo_ano_siguiente_porcentaje || 40;
                document.getElementById('fp-descuento-pronto-pago').value = params.descuento_pronto_pago_porcentaje || 10;
                document.getElementById('fp-descuento-dias').value = params.descuento_pronto_pago_dias || 30;
                document.getElementById('fp-interes-mora').value = params.interes_mora_mensual || 1;
            } catch (error) {
                console.error('Error loading formula parameters:', error);
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        
        // Filtros de tabla
        document.getElementById('muni-filter-search').addEventListener('input', filterMunicipalities);
        document.getElementById('muni-filter-dept').addEventListener('change', filterMunicipalities);
        
        // Paginaci√≥n
        document.getElementById('muni-prev').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderMunicipalitiesTable();
            }
        });
        
        document.getElementById('muni-next').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredMunicipalities.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderMunicipalitiesTable();
            }
        });
        
        // Formulario de par√°metros de f√≥rmulas
        document.getElementById('formula-params-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const municipalityId = document.getElementById('fp-municipality').value;
            if (!municipalityId) {
                alert('Seleccione un municipio');
                return;
            }
            
            try {
                showLoading();
                
                const params = {
                    avisos_tableros_porcentaje: parseFloat(document.getElementById('fp-avisos-tableros').value) || 15,
                    sobretasa_bomberil_porcentaje: parseFloat(document.getElementById('fp-sobretasa-bomberil').value) || 0,
                    sobretasa_seguridad_porcentaje: parseFloat(document.getElementById('fp-sobretasa-seguridad').value) || 0,
                    ley_56_tarifa_por_kw: parseFloat(document.getElementById('fp-ley56-tarifa').value) || 0,
                    unidades_adicionales_financiero_valor: parseFloat(document.getElementById('fp-unidades-financiero').value) || 0,
                    anticipo_ano_siguiente_porcentaje: parseFloat(document.getElementById('fp-anticipo').value) || 40,
                    descuento_pronto_pago_porcentaje: parseFloat(document.getElementById('fp-descuento-pronto-pago').value) || 10,
                    descuento_pronto_pago_dias: parseInt(document.getElementById('fp-descuento-dias').value) || 30,
                    interes_mora_mensual: parseFloat(document.getElementById('fp-interes-mora').value) || 1
                };
                
                await AdminAPI.updateFormulaParameters(municipalityId, params);
                
                hideLoading();
                alert('‚úÖ Par√°metros de f√≥rmulas actualizados correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // Formulario de configuraci√≥n marca blanca
        document.getElementById('white-label-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const municipalityId = document.getElementById('wl-municipality').value;
            if (!municipalityId) {
                alert('Seleccione un municipio');
                return;
            }
            
            try {
                showLoading();
                
                const config = {
                    app_name: document.getElementById('wl-app-name').value,
                    form_title: document.getElementById('wl-form-title').value,
                    primary_color: document.getElementById('wl-primary-color').value,
                    secondary_color: document.getElementById('wl-secondary-color').value,
                    accent_color: document.getElementById('wl-accent-color').value,
                    font_family: document.getElementById('wl-font').value,
                    header_text: document.getElementById('wl-header').value,
                    legal_notes: document.getElementById('wl-legal').value,
                    footer_text: document.getElementById('wl-footer').value,
                    watermark_text: document.getElementById('wl-watermark').value,
                    // Configuraci√≥n de numeraci√≥n
                    consecutivo_prefijo: document.getElementById('wl-consecutivo-prefijo').value,
                    consecutivo_actual: parseInt(document.getElementById('wl-consecutivo-inicio').value) || 1,
                    consecutivo_digitos: parseInt(document.getElementById('wl-consecutivo-digitos').value) || 12,
                    radicado_prefijo: document.getElementById('wl-radicado-prefijo').value,
                    radicado_actual: parseInt(document.getElementById('wl-radicado-inicio').value) || 1,
                    radicado_digitos: parseInt(document.getElementById('wl-radicado-digitos').value) || 16
                };
                
                await AdminAPI.updateWhiteLabelConfig(municipalityId, config);
                
                // Subir logo si se seleccion√≥
                const logoInput = document.getElementById('wl-logo');
                if (logoInput.files.length > 0) {
                    await AdminAPI.uploadLogo(municipalityId, logoInput.files[0]);
                }
                
                hideLoading();
                alert('‚úÖ Configuraci√≥n guardada correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // (Formulario de creaci√≥n de actividades eliminado - los c√≥digos CIIU vienen precargados del cat√°logo nacional)
        
        // ==================== FUNCIONES AUXILIARES ====================
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            if (!container) return;
            
            const alertClass = {
                'success': 'alert-success',
                'danger': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.innerHTML = `
                <span>${message}</span>
                <button class="alert-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(alert);
            
            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }
        
        async function deleteActivity(activityId) {
            if (!confirm('¬øEst√° seguro de eliminar esta actividad?')) {
                return;
            }
            
            try {
                showLoading();
                await AdminAPI.deleteActivity(activityId);
                
                const municipalityId = document.getElementById('act-municipality').value;
                if (municipalityId) {
                    loadActivities(municipalityId);
                }
                
                hideLoading();
                alert('‚úÖ Actividad eliminada correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        }
        
        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await AuthAPI.logout();
            localStorage.removeItem('selectedMunicipality');
            window.location.href = 'login.html';
        });
        
        // ==================== SISTEMA DE PESTA√ëAS ====================
        
        function switchTab(tabId) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pesta√±a seleccionada
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Activar el bot√≥n correspondiente
            document.querySelector(`.admin-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Si es la pesta√±a de formularios, cargar las declaraciones
            if (tabId === 'forms') {
                loadAllDeclarations();
            }
            
            // Si es la pesta√±a de backups, cargar la lista de backups
            if (tabId === 'backups') {
                loadBackupsList();
            }
        }
        
        // ==================== GESTI√ìN DE FORMULARIOS ====================
        
        let declarationsCurrentPage = 1;
        const DECLARATIONS_PER_PAGE = 10;
        let allDeclarationsData = [];
        
        async function searchDeclarations() {
            const filingNumber = document.getElementById('search-filing-number').value.trim();
            const formNumber = document.getElementById('search-form-number').value.trim();
            const document_num = document.getElementById('search-document').value.trim();
            
            if (!filingNumber && !formNumber && !document_num) {
                showAlert('‚ö†Ô∏è Ingrese al menos un criterio de b√∫squeda', 'warning');
                return;
            }
            
            try {
                showLoading();
                
                // Construir par√°metros de b√∫squeda
                const params = new URLSearchParams();
                if (filingNumber) params.append('filing_number', filingNumber);
                if (formNumber) params.append('form_number', formNumber);
                if (document_num) params.append('document_number', document_num);
                
                // Usar fetch con la API de declaraciones
                const declarations = await DeclarationsAPI.search(params.toString());
                allDeclarationsData = declarations;
                declarationsCurrentPage = 1;
                renderDeclarationsResults();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error searching declarations:', error);
                showAlert('‚ùå Error al buscar: ' + error.message, 'danger');
            }
        }
        
        async function loadAllDeclarations() {
            try {
                showLoading();
                
                // Usar DeclarationsAPI que maneja correctamente la autenticaci√≥n
                const declarations = await DeclarationsAPI.list();
                allDeclarationsData = declarations;
                declarationsCurrentPage = 1;
                renderDeclarationsResults();
                
                hideLoading();
            } catch (error) {
                hideLoading();
                console.error('Error loading declarations:', error);
                showAlert('‚ùå Error al cargar declaraciones: ' + error.message, 'danger');
            }
        }
        
        function renderDeclarationsResults() {
            const tbody = document.getElementById('declarations-results');
            const statsDiv = document.getElementById('declarations-stats');
            const declarations = allDeclarationsData;
            
            if (!declarations || declarations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            No se encontraron declaraciones con los criterios especificados
                        </td>
                    </tr>
                `;
                statsDiv.style.display = 'none';
                renderDeclarationsPagination(0);
                return;
            }
            
            // Mostrar estad√≠sticas
            statsDiv.style.display = 'block';
            document.getElementById('stat-forms-total').textContent = declarations.length;
            document.getElementById('stat-forms-signed').textContent = 
                declarations.filter(d => d.is_signed).length;
            document.getElementById('stat-forms-draft').textContent = 
                declarations.filter(d => d.status === 'borrador').length;
            document.getElementById('stat-forms-corrections').textContent = 
                declarations.filter(d => d.correction_of_id).length;
            
            // Calcular paginaci√≥n
            const totalPages = Math.ceil(declarations.length / DECLARATIONS_PER_PAGE);
            const startIndex = (declarationsCurrentPage - 1) * DECLARATIONS_PER_PAGE;
            const endIndex = startIndex + DECLARATIONS_PER_PAGE;
            const pageDeclarations = declarations.slice(startIndex, endIndex);
            
            // Renderizar tabla con p√°gina actual
            tbody.innerHTML = pageDeclarations.map(d => {
                const taxpayerName = d.taxpayer?.legal_name || 'Sin nombre';
                const taxpayerDoc = d.taxpayer?.document_number || '-';
                const filingDate = d.filing_date 
                    ? new Date(d.filing_date).toLocaleDateString('es-CO', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    })
                    : '-';
                
                return `
                    <tr>
                        <td style="font-family: 'Roboto Mono', monospace; font-size: 0.85rem;">
                            ${d.filing_number || '<span style="color: #9ca3af;">Pendiente</span>'}
                        </td>
                        <td style="font-size: 0.85rem;">${d.form_number || '-'}</td>
                        <td>${taxpayerName}</td>
                        <td>${taxpayerDoc}</td>
                        <td>${d.tax_year}</td>
                        <td>
                            <span class="badge badge-${d.status}">
                                ${d.status.toUpperCase()}
                            </span>
                            ${d.correction_of_id ? '<span class="badge" style="background: #8b5cf6; margin-left: 2px; font-size: 0.7rem;">Correcci√≥n</span>' : ''}
                        </td>
                        <td style="font-size: 0.85rem;">${filingDate}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="form.html?id=${d.id}&preview=true" class="btn btn-sm btn-primary" target="_blank" title="Ver formulario">
                                    üëÅÔ∏è
                                </a>
                                ${d.is_signed ? `
                                    <button class="btn btn-sm btn-secondary" onclick="downloadDeclarationPDF(${d.id})" title="Descargar PDF">
                                        üìÑ
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Renderizar paginaci√≥n
            renderDeclarationsPagination(totalPages);
        }
        
        function renderDeclarationsPagination(totalPages) {
            const paginationContainer = document.getElementById('declarations-pagination');
            
            if (!paginationContainer) return;
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let html = `
                <button onclick="goToDeclarationsPage(1)" ${declarationsCurrentPage === 1 ? 'disabled' : ''}>¬´</button>
                <button onclick="goToDeclarationsPage(${declarationsCurrentPage - 1})" ${declarationsCurrentPage === 1 ? 'disabled' : ''}>‚Äπ</button>
            `;
            
            // Mostrar n√∫meros de p√°gina
            const startPage = Math.max(1, declarationsCurrentPage - 2);
            const endPage = Math.min(totalPages, declarationsCurrentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="goToDeclarationsPage(${i})" class="${i === declarationsCurrentPage ? 'active' : ''}">${i}</button>`;
            }
            
            html += `
                <button onclick="goToDeclarationsPage(${declarationsCurrentPage + 1})" ${declarationsCurrentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>
                <button onclick="goToDeclarationsPage(${totalPages})" ${declarationsCurrentPage === totalPages ? 'disabled' : ''}>¬ª</button>
                <span class="pagination-info">P√°gina ${declarationsCurrentPage} de ${totalPages} (${allDeclarationsData.length} registros)</span>
            `;
            
            paginationContainer.innerHTML = html;
        }
        
        function goToDeclarationsPage(page) {
            const totalPages = Math.ceil(allDeclarationsData.length / DECLARATIONS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            declarationsCurrentPage = page;
            renderDeclarationsResults();
        }
        
        async function downloadDeclarationPDF(declarationId) {
            try {
                showLoading();
                await DeclarationsAPI.downloadPDF(declarationId);
                hideLoading();
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al descargar PDF: ' + error.message, 'danger');
            }
        }
        
        // Mostrar/ocultar secci√≥n seg√∫n rol
        function setupFormManagementSection(user) {
            const formsTab = document.querySelector('.admin-tab[data-tab="forms"]');
            const formsSection = document.getElementById('tab-forms');
            
            // La pesta√±a de Formularios solo visible para admin_alcaldia y admin_sistema
            if (user.role === 'admin_alcaldia' || user.role === 'admin_sistema') {
                if (formsTab) formsTab.style.display = 'block';
            } else {
                if (formsTab) formsTab.style.display = 'none';
                // Asegurarse de que no est√© activa si se oculta
                if (formsSection) formsSection.classList.remove('active');
            }
        }
        
        // ==================== GESTI√ìN DE BACKUPS ====================
        
        async function loadBackupsList() {
            const tbody = document.getElementById('backups-list');
            
            try {
                const result = await AdminAPI.listBackups();
                const backups = result.backups || [];
                
                if (backups.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted">
                                No hay backups disponibles. Cree uno usando el bot√≥n "Crear Backup".
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = backups.map(backup => {
                    const date = new Date(backup.created_at).toLocaleString('es-CO', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    });
                    const typeIcon = backup.type === 'sql' ? 'üóÑÔ∏è' : 'üìÑ';
                    const typeBadge = backup.type === 'sql' 
                        ? '<span class="badge" style="background: #3b82f6; color: white;">SQL</span>'
                        : '<span class="badge" style="background: #10b981; color: white;">JSON</span>';
                    
                    // Bot√≥n de restaurar solo para JSON
                    const restoreButton = backup.type === 'json' 
                        ? `<button class="btn btn-sm btn-success" onclick="restoreBackup('${backup.filename}')" title="Restaurar (Hotswap)">
                               üîÑ
                           </button>`
                        : '';
                    
                    return `
                        <tr>
                            <td style="font-family: 'Roboto Mono', monospace; font-size: 0.85rem;">
                                ${typeIcon} ${backup.filename}
                            </td>
                            <td>${typeBadge}</td>
                            <td>${backup.size_mb} MB</td>
                            <td>${date}</td>
                            <td>
                                <div class="d-flex gap-1">
                                    ${restoreButton}
                                    <button class="btn btn-sm btn-primary" onclick="downloadBackup('${backup.filename}')" title="Descargar">
                                        üì•
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.filename}')" title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading backups:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Error al cargar backups: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        async function createBackup() {
            if (!confirm('¬øDesea crear un nuevo backup de la base de datos?')) {
                return;
            }
            
            try {
                showLoading();
                const result = await AdminAPI.createBackup();
                hideLoading();
                
                showAlert(`‚úÖ ${result.message}. Archivo: ${result.filename} (${result.size_mb} MB)`, 'success');
                loadBackupsList();
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al crear backup: ' + error.message, 'danger');
            }
        }
        
        async function downloadBackup(filename) {
            try {
                showLoading();
                await AdminAPI.downloadBackup(filename);
                hideLoading();
                showAlert('‚úÖ Backup descargado correctamente', 'success');
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al descargar backup: ' + error.message, 'danger');
            }
        }
        
        async function uploadBackupFile(input) {
            if (!input.files || input.files.length === 0) {
                return;
            }
            
            const file = input.files[0];
            
            if (!file.name.endsWith('.sql') && !file.name.endsWith('.json')) {
                showAlert('‚ùå Solo se permiten archivos .sql o .json', 'danger');
                input.value = '';
                return;
            }
            
            if (!confirm(`¬øDesea subir el archivo "${file.name}"?`)) {
                input.value = '';
                return;
            }
            
            try {
                showLoading();
                const result = await AdminAPI.uploadBackup(file);
                hideLoading();
                
                showAlert(`‚úÖ ${result.message}. Guardado como: ${result.saved_filename}`, 'success');
                loadBackupsList();
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al subir backup: ' + error.message, 'danger');
            }
            
            input.value = '';
        }
        
        async function deleteBackup(filename) {
            if (!confirm(`¬øEst√° seguro de eliminar el backup "${filename}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                showLoading();
                await AdminAPI.deleteBackup(filename);
                hideLoading();
                
                showAlert('‚úÖ Backup eliminado correctamente', 'success');
                loadBackupsList();
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al eliminar backup: ' + error.message, 'danger');
            }
        }
        
        async function restoreBackup(filename) {
            if (!confirm(`¬øEst√° seguro de restaurar el backup "${filename}"?\n\nEsta acci√≥n importar√° las declaraciones del backup que no existan en la base de datos actual.\n\nNOTA: Las declaraciones existentes NO ser√°n sobrescritas.`)) {
                return;
            }
            
            try {
                showLoading();
                const result = await AdminAPI.restoreBackup(filename);
                hideLoading();
                
                let message = `‚úÖ ${result.message}\n`;
                message += `üìã Declaraciones restauradas: ${result.restored_count}\n`;
                message += `‚è≠Ô∏è Declaraciones omitidas (ya existentes): ${result.skipped_count}`;
                
                if (result.errors && result.errors.length > 0) {
                    message += `\n‚ö†Ô∏è Errores: ${result.errors.length}`;
                }
                
                showAlert(message, 'success');
                
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al restaurar backup: ' + error.message, 'danger');
            }
        }
        
        // ==================== INICIALIZACI√ìN ====================
        loadUserData();
        loadMunicipalities();
        updateSerialPreview();
    </script>
</body>
</html>
