<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Panel de Administraci√≥n - Sistema ICA">
    <title>Administraci√≥n - Sistema ICA</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Estilos para autocompletado de municipios */
        .municipality-search-container {
            position: relative;
        }
        .municipality-search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
        }
        .municipality-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }
        .municipality-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .municipality-dropdown.active {
            display: block;
        }
        .municipality-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .municipality-option:hover,
        .municipality-option.highlighted {
            background-color: var(--primary-color);
            color: white;
        }
        .municipality-option .dept {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .municipality-selected {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .municipality-selected .clear-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .municipality-selected .clear-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination-info {
            margin: 0 1rem;
            color: var(--text-muted);
        }
        
        /* Filtro de b√∫squeda para tabla */
        .table-filter {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .table-filter input,
        .table-filter select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            flex: 1;
            min-width: 200px;
        }
        
        /* Configuraci√≥n de consecutivo */
        .serial-config-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px dashed var(--primary-color);
            padding: 1.5rem;
            border-radius: var(--radius);
            margin-top: 1rem;
        }
        .serial-preview {
            font-family: 'Courier New', monospace;
            font-size: 1.25rem;
            background: #2d3748;
            color: #68d391;
            padding: 1rem;
            border-radius: var(--radius);
            margin-top: 0.5rem;
        }
        
        /* Modal de edici√≥n */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-header .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            border-radius: 4px;
            line-height: 1;
        }
        .modal-header .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        /* Filas editables */
        #municipalities-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }
        #municipalities-table tbody tr:hover {
            background: #f0f4f8;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <span class="logo-text">Sistema ICA - Admin</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html">Panel Usuario</a></li>
                    <li><a href="admin.html" class="active">Administraci√≥n</a></li>
                    <li><a href="superadmin.html" id="superadmin-link" style="display: none;">Super Admin</a></li>
                </ul>
            </nav>
            
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-outline" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div id="alert-container"></div>
            
            <h1>Panel de Administraci√≥n</h1>
            <p class="text-muted">Configuraci√≥n marca blanca y gesti√≥n del sistema</p>
            
            <!-- Acciones r√°pidas -->
            <div class="row" style="margin-top: 1rem; margin-bottom: 1rem;">
                <div class="col-12">
                    <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid var(--primary-color);">
                        <div class="card-body">
                            <div class="d-flex justify-between align-center">
                                <div>
                                    <strong>üëÅÔ∏è Vista Previa del Formulario</strong>
                                    <p class="text-muted mb-0" style="font-size: 0.875rem;">Verifique la estructura de campos del formulario ICA sin necesidad de llenarlo.</p>
                                </div>
                                <a href="form.html?preview=true" class="btn btn-primary">
                                    üëÅÔ∏è Ver Vista Previa
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row" style="margin-top: 2rem;">
                <!-- Configuraci√≥n Marca Blanca -->
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            üé® Configuraci√≥n Marca Blanca
                        </div>
                        <div class="card-body">
                            <form id="white-label-form">
                                <div class="form-group">
                                    <label class="form-label">Municipio</label>
                                    <div class="municipality-search-container">
                                        <input type="text" 
                                               id="wl-municipality-search" 
                                               class="municipality-search-input" 
                                               placeholder="Buscar municipio por nombre..."
                                               autocomplete="off">
                                        <input type="hidden" id="wl-municipality" value="">
                                        <div id="wl-municipality-dropdown" class="municipality-dropdown"></div>
                                    </div>
                                    <div id="wl-municipality-selected" class="municipality-selected" style="display: none;">
                                        <span id="wl-municipality-name"></span>
                                        <button type="button" class="clear-btn" onclick="clearMunicipalitySelection('wl')">‚úï</button>
                                    </div>
                                </div>
                                
                                <!-- Configuraci√≥n de Consecutivo y Radicado -->
                                <div class="serial-config-card">
                                    <h4 style="margin-bottom: 1rem;">üìã Configuraci√≥n de Numeraci√≥n</h4>
                                    <div class="alert alert-info" style="margin-bottom: 1rem;">
                                        <strong>üí° Instrucciones:</strong> Configure el prefijo y el n√∫mero inicial para consecutivos y radicados.
                                        El sistema generar√° autom√°ticamente n√∫meros secuenciales.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-consecutivo-prefijo" class="form-label">Prefijo Consecutivo</label>
                                                <input type="text" id="wl-consecutivo-prefijo" class="form-control" 
                                                       placeholder="" maxlength="10">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-consecutivo-inicio" class="form-label">N√∫mero Inicial</label>
                                                <input type="number" id="wl-consecutivo-inicio" class="form-control" 
                                                       value="1" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-consecutivo-digitos" class="form-label">D√≠gitos (relleno con ceros)</label>
                                                <input type="number" id="wl-consecutivo-digitos" class="form-control" 
                                                       value="12" min="6" max="20">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label class="form-label">Vista Previa Consecutivo</label>
                                                <div class="serial-preview" id="consecutivo-preview">000000000001</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr style="margin: 1rem 0;">
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-radicado-prefijo" class="form-label">Prefijo Radicado</label>
                                                <input type="text" id="wl-radicado-prefijo" class="form-control" 
                                                       placeholder="" maxlength="10">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-radicado-inicio" class="form-label">N√∫mero Inicial</label>
                                                <input type="number" id="wl-radicado-inicio" class="form-control" 
                                                       value="1" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label for="wl-radicado-digitos" class="form-label">D√≠gitos (relleno con ceros)</label>
                                                <input type="number" id="wl-radicado-digitos" class="form-control" 
                                                       value="16" min="6" max="20">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group">
                                                <label class="form-label">Vista Previa Radicado</label>
                                                <div class="serial-preview" id="radicado-preview">0000000000000001</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-top: 1.5rem;">
                                    <label for="wl-form-title" class="form-label">T√≠tulo del Formulario</label>
                                    <input type="text" id="wl-form-title" class="form-control" 
                                           value="Formulario √önico Nacional de Declaraci√≥n y Pago ICA">
                                </div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="wl-primary-color" class="form-label">Color Primario</label>
                                            <input type="color" id="wl-primary-color" class="form-control" value="#003366">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="wl-secondary-color" class="form-label">Color Secundario</label>
                                            <input type="color" id="wl-secondary-color" class="form-control" value="#0066CC">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="wl-accent-color" class="form-label">Color Acento</label>
                                            <input type="color" id="wl-accent-color" class="form-control" value="#FF9900">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-font" class="form-label">Tipograf√≠a</label>
                                    <select id="wl-font" class="form-control">
                                        <option value="Arial, sans-serif">Arial</option>
                                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                                        <option value="'Times New Roman', serif">Times New Roman</option>
                                        <option value="Georgia, serif">Georgia</option>
                                        <option value="'Roboto', sans-serif">Roboto</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-header" class="form-label">Texto de Encabezado</label>
                                    <textarea id="wl-header" class="form-control" rows="2" 
                                              placeholder="Texto institucional para el encabezado..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-legal" class="form-label">Notas Legales</label>
                                    <textarea id="wl-legal" class="form-control" rows="3" 
                                              placeholder="Notas legales para el pie del formulario..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-footer" class="form-label">Texto de Pie de P√°gina</label>
                                    <textarea id="wl-footer" class="form-control" rows="2" 
                                              placeholder="Texto para el pie de p√°gina..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-watermark" class="form-label">üîí Marca de Agua (PDF)</label>
                                    <input type="text" id="wl-watermark" class="form-control" 
                                           placeholder="Ej: Alcald√≠a de Medell√≠n - Documento Oficial"
                                           maxlength="255">
                                    <small class="form-text">Este texto aparecer√° como marca de agua diagonal en los PDFs generados para prevenir fraudes.</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="wl-logo" class="form-label">Logo Institucional</label>
                                    <input type="file" id="wl-logo" class="form-control" accept="image/*">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    üíæ Guardar Configuraci√≥n
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Actividades Econ√≥micas -->
                <div class="col-6">
                    <div class="card">
                        <div class="card-header">
                            üìä Actividades Econ√≥micas (CIIU)
                        </div>
                        <div class="card-body">
                            <form id="activity-form">
                                <div class="form-group">
                                    <label class="form-label">Municipio</label>
                                    <div class="municipality-search-container">
                                        <input type="text" 
                                               id="act-municipality-search" 
                                               class="municipality-search-input" 
                                               placeholder="Buscar municipio por nombre..."
                                               autocomplete="off">
                                        <input type="hidden" id="act-municipality" value="">
                                        <div id="act-municipality-dropdown" class="municipality-dropdown"></div>
                                    </div>
                                    <div id="act-municipality-selected" class="municipality-selected" style="display: none;">
                                        <span id="act-municipality-name"></span>
                                        <button type="button" class="clear-btn" onclick="clearMunicipalitySelection('act')">‚úï</button>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="act-ciiu" class="form-label">C√≥digo CIIU</label>
                                            <input type="text" id="act-ciiu" class="form-control" placeholder="G4711">
                                        </div>
                                    </div>
                                    <div class="col-8">
                                        <div class="form-group">
                                            <label for="act-description" class="form-label">Descripci√≥n</label>
                                            <input type="text" id="act-description" class="form-control" 
                                                   placeholder="Comercio al por menor">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="act-rate" class="form-label">Tarifa ICA (‚Ä∞)</label>
                                    <input type="number" id="act-rate" class="form-control" 
                                           min="0" max="100" step="0.01" value="4.14">
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    ‚ûï Agregar Actividad
                                </button>
                            </form>
                            
                            <hr>
                            
                            <h4>Actividades Registradas</h4>
                            <table class="table" id="activities-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Tarifa</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="activities-body">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">
                                            Seleccione un municipio para ver actividades
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Par√°metros de F√≥rmulas (Edici√≥n en Caliente) -->
            <div class="row" style="margin-top: 2rem;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            ‚öôÔ∏è Par√°metros de F√≥rmulas (Edici√≥n en Caliente)
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>üìå Nota:</strong> Estos par√°metros permiten ajustar los valores num√©ricos de las f√≥rmulas 
                                del formulario ICA sin necesidad de modificar el c√≥digo. Use esta funcionalidad cuando cambien 
                                las legislaciones municipales.
                            </div>
                            
                            <form id="formula-params-form">
                                <div class="form-group">
                                    <label class="form-label">Municipio</label>
                                    <div class="municipality-search-container">
                                        <input type="text" 
                                               id="fp-municipality-search" 
                                               class="municipality-search-input" 
                                               placeholder="Buscar municipio por nombre..."
                                               autocomplete="off">
                                        <input type="hidden" id="fp-municipality" value="">
                                        <div id="fp-municipality-dropdown" class="municipality-dropdown"></div>
                                    </div>
                                    <div id="fp-municipality-selected" class="municipality-selected" style="display: none;">
                                        <span id="fp-municipality-name"></span>
                                        <button type="button" class="clear-btn" onclick="clearMunicipalitySelection('fp')">‚úï</button>
                                    </div>
                                </div>
                                
                                <div class="section-title" style="margin-top: 1.5rem;">Secci√≥n D - Liquidaci√≥n del Impuesto</div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-avisos-tableros" class="form-label">
                                                Avisos y Tableros (% sobre ICA)
                                                <small class="text-muted">Rengl√≥n 21</small>
                                            </label>
                                            <input type="number" id="fp-avisos-tableros" class="form-control" 
                                                   min="0" max="100" step="0.1" value="15">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-sobretasa-bomberil" class="form-label">
                                                Sobretasa Bomberil (%)
                                                <small class="text-muted">Rengl√≥n 23</small>
                                            </label>
                                            <input type="number" id="fp-sobretasa-bomberil" class="form-control" 
                                                   min="0" max="100" step="0.1" value="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-sobretasa-seguridad" class="form-label">
                                                Sobretasa Seguridad (%)
                                                <small class="text-muted">Rengl√≥n 24</small>
                                            </label>
                                            <input type="number" id="fp-sobretasa-seguridad" class="form-control" 
                                                   min="0" max="100" step="0.1" value="0">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-ley56-tarifa" class="form-label">
                                                Ley 56/1981 - Tarifa por kW
                                                <small class="text-muted">Rengl√≥n 19</small>
                                            </label>
                                            <input type="number" id="fp-ley56-tarifa" class="form-control" 
                                                   min="0" step="0.01" value="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-unidades-financiero" class="form-label">
                                                Unidades Adicionales Financiero
                                                <small class="text-muted">Rengl√≥n 22</small>
                                            </label>
                                            <input type="number" id="fp-unidades-financiero" class="form-control" 
                                                   min="0" step="0.01" value="0">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-anticipo" class="form-label">
                                                Anticipo A√±o Siguiente (%)
                                                <small class="text-muted">Rengl√≥n 30</small>
                                            </label>
                                            <input type="number" id="fp-anticipo" class="form-control" 
                                                   min="0" max="100" step="0.1" value="40">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="section-title" style="margin-top: 1.5rem;">Secci√≥n E - Pago</div>
                                
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-descuento-pronto-pago" class="form-label">
                                                Descuento Pronto Pago (%)
                                                <small class="text-muted">Rengl√≥n 36</small>
                                            </label>
                                            <input type="number" id="fp-descuento-pronto-pago" class="form-control" 
                                                   min="0" max="100" step="0.1" value="10">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-descuento-dias" class="form-label">
                                                D√≠as para Descuento
                                                <small class="text-muted">D√≠as l√≠mite</small>
                                            </label>
                                            <input type="number" id="fp-descuento-dias" class="form-control" 
                                                   min="0" value="30">
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-group">
                                            <label for="fp-interes-mora" class="form-label">
                                                Inter√©s Mora Mensual (%)
                                                <small class="text-muted">Rengl√≥n 37</small>
                                            </label>
                                            <input type="number" id="fp-interes-mora" class="form-control" 
                                                   min="0" max="100" step="0.01" value="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">
                                    üíæ Guardar Par√°metros de F√≥rmulas
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gesti√≥n de Municipios con Paginaci√≥n -->
            <div class="row" style="margin-top: 2rem;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            üèõÔ∏è Gesti√≥n de Municipios
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <strong>üìå Nota:</strong> Haga doble clic sobre cualquier municipio para editar su c√≥digo DANE 
                                en caso de que no coincida con el c√≥digo oficial publicado por el DANE.
                            </div>
                            
                            <!-- Filtros de b√∫squeda -->
                            <div class="table-filter">
                                <input type="text" id="muni-filter-search" placeholder="üîç Buscar por nombre o c√≥digo...">
                                <select id="muni-filter-dept">
                                    <option value="">Todos los departamentos</option>
                                </select>
                            </div>
                            
                            <table class="table" id="municipalities-table">
                                <thead>
                                    <tr>
                                        <th>C√≥digo DANE</th>
                                        <th>Municipio</th>
                                        <th>Departamento</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="municipalities-body">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">
                                            Cargando municipios...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Paginaci√≥n -->
                            <div class="pagination" id="municipalities-pagination">
                                <button id="muni-prev" disabled>‚Üê Anterior</button>
                                <span class="pagination-info" id="muni-page-info">P√°gina 1 de 1</span>
                                <button id="muni-next" disabled>Siguiente ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal de Edici√≥n de Municipio -->
            <div id="edit-municipality-modal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Municipio</h3>
                        <button type="button" class="close-btn" onclick="closeEditMunicipalityModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-municipality-form">
                            <input type="hidden" id="edit-muni-id">
                            <div class="form-group">
                                <label for="edit-muni-code" class="form-label">C√≥digo DANE</label>
                                <input type="text" id="edit-muni-code" class="form-control" required>
                                <small class="text-muted">Modifique este c√≥digo solo si no coincide con el oficial del DANE</small>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="edit-muni-name" class="form-label">Nombre del Municipio</label>
                                <input type="text" id="edit-muni-name" class="form-control" readonly>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label for="edit-muni-dept" class="form-label">Departamento</label>
                                <input type="text" id="edit-muni-dept" class="form-control" readonly>
                            </div>
                            <div class="modal-footer" style="margin-top: 1.5rem;">
                                <button type="button" class="btn btn-secondary" onclick="closeEditMunicipalityModal()">Cancelar</button>
                                <button type="submit" class="btn btn-primary">üíæ Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema ICA - Panel de Administraci√≥n</p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script src="../js/api.js"></script>
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let allMunicipalities = [];
        let filteredMunicipalities = [];
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        
        // Municipio seleccionado guardado en localStorage
        let selectedMunicipality = JSON.parse(localStorage.getItem('selectedMunicipality') || 'null');
        
        // ==================== VERIFICAR AUTENTICACI√ìN ====================
        if (!AuthAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // ==================== FUNCIONES DE MUNICIPIOS ====================
        
        // Cargar todos los municipios
        async function loadMunicipalities() {
            try {
                allMunicipalities = await AdminAPI.listMunicipalities();
                filteredMunicipalities = [...allMunicipalities];
                
                // Llenar filtro de departamentos
                fillDepartmentFilter();
                
                // Renderizar tabla paginada
                renderMunicipalitiesTable();
                
                // Inicializar buscadores de municipios
                initMunicipalitySearchers();
                
                // Restaurar municipio seleccionado si existe
                if (selectedMunicipality) {
                    restoreSelectedMunicipality();
                }
            } catch (error) {
                console.error('Error loading municipalities:', error);
            }
        }
        
        // Llenar filtro de departamentos
        function fillDepartmentFilter() {
            const departments = [...new Set(allMunicipalities.map(m => m.department))].sort();
            const select = document.getElementById('muni-filter-dept');
            select.innerHTML = '<option value="">Todos los departamentos</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }
        
        // Filtrar municipios
        function filterMunicipalities() {
            const searchTerm = document.getElementById('muni-filter-search').value.toLowerCase();
            const deptFilter = document.getElementById('muni-filter-dept').value;
            
            filteredMunicipalities = allMunicipalities.filter(m => {
                const matchesSearch = !searchTerm || 
                    m.name.toLowerCase().includes(searchTerm) || 
                    m.code.includes(searchTerm);
                const matchesDept = !deptFilter || m.department === deptFilter;
                return matchesSearch && matchesDept;
            });
            
            currentPage = 1;
            renderMunicipalitiesTable();
        }
        
        // Renderizar tabla de municipios con paginaci√≥n
        function renderMunicipalitiesTable() {
            const tbody = document.getElementById('municipalities-body');
            const totalPages = Math.ceil(filteredMunicipalities.length / ITEMS_PER_PAGE);
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const pageData = filteredMunicipalities.slice(start, end);
            
            if (filteredMunicipalities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No se encontraron municipios</td></tr>';
            } else {
                tbody.innerHTML = pageData.map(m => `
                    <tr ondblclick="openEditMunicipalityModal(${m.id}, '${m.code}', '${m.name.replace(/'/g, "\\'")}', '${m.department.replace(/'/g, "\\'")}')">
                        <td><strong>${m.code}</strong></td>
                        <td>${m.name}</td>
                        <td>${m.department}</td>
                        <td>
                            <span class="badge ${m.is_active ? 'badge-firmado' : 'badge-anulado'}">
                                ${m.is_active ? 'ACTIVO' : 'INACTIVO'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Actualizar paginaci√≥n
            document.getElementById('muni-page-info').textContent = 
                `P√°gina ${currentPage} de ${totalPages || 1} (${filteredMunicipalities.length} municipios)`;
            document.getElementById('muni-prev').disabled = currentPage <= 1;
            document.getElementById('muni-next').disabled = currentPage >= totalPages;
        }
        
        // ==================== MODAL DE EDICI√ìN DE MUNICIPIO ====================
        
        function openEditMunicipalityModal(id, code, name, department) {
            document.getElementById('edit-muni-id').value = id;
            document.getElementById('edit-muni-code').value = code;
            document.getElementById('edit-muni-name').value = name;
            document.getElementById('edit-muni-dept').value = department;
            document.getElementById('edit-municipality-modal').style.display = 'flex';
        }
        
        function closeEditMunicipalityModal() {
            document.getElementById('edit-municipality-modal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('edit-municipality-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditMunicipalityModal();
            }
        });
        
        // Formulario de edici√≥n de municipio
        document.getElementById('edit-municipality-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-muni-id').value;
            const code = document.getElementById('edit-muni-code').value;
            const name = document.getElementById('edit-muni-name').value;
            const department = document.getElementById('edit-muni-dept').value;
            
            try {
                showLoading();
                
                await AdminAPI.updateMunicipality(id, {
                    code: code,
                    name: name,
                    department: department
                });
                
                closeEditMunicipalityModal();
                await loadMunicipalities();
                
                hideLoading();
                alert('‚úÖ C√≥digo DANE actualizado correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // ==================== BUSCADOR DE MUNICIPIOS (AUTOCOMPLETE) ====================
        
        function initMunicipalitySearchers() {
            const searchConfigs = [
                { prefix: 'wl', onSelect: loadWhiteLabelConfig },
                { prefix: 'act', onSelect: loadActivities },
                { prefix: 'fp', onSelect: loadFormulaParameters }
            ];
            
            searchConfigs.forEach(config => {
                const input = document.getElementById(`${config.prefix}-municipality-search`);
                const dropdown = document.getElementById(`${config.prefix}-municipality-dropdown`);
                const hiddenInput = document.getElementById(`${config.prefix}-municipality`);
                
                if (!input || !dropdown) return;
                
                // Evento de escritura
                input.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    
                    if (searchTerm.length < 1) {
                        dropdown.classList.remove('active');
                        return;
                    }
                    
                    const matches = allMunicipalities.filter(m => 
                        m.name.toLowerCase().includes(searchTerm) || 
                        m.department.toLowerCase().includes(searchTerm) ||
                        m.code.includes(searchTerm)
                    ).slice(0, 10);
                    
                    if (matches.length > 0) {
                        dropdown.innerHTML = matches.map(m => `
                            <div class="municipality-option" data-id="${m.id}" data-name="${m.name}" data-dept="${m.department}">
                                <strong>${m.name}</strong>
                                <span class="dept">(${m.department} - ${m.code})</span>
                            </div>
                        `).join('');
                        dropdown.classList.add('active');
                        
                        // Eventos de click en opciones
                        dropdown.querySelectorAll('.municipality-option').forEach(opt => {
                            opt.addEventListener('click', () => {
                                const id = opt.dataset.id;
                                const name = opt.dataset.name;
                                const dept = opt.dataset.dept;
                                
                                selectMunicipality(config.prefix, id, name, dept);
                                dropdown.classList.remove('active');
                                input.value = '';
                                
                                // Ejecutar callback
                                if (config.onSelect) {
                                    config.onSelect(id);
                                }
                            });
                        });
                    } else {
                        dropdown.innerHTML = '<div class="municipality-option">No se encontraron resultados</div>';
                        dropdown.classList.add('active');
                    }
                });
                
                // Cerrar dropdown al hacer clic fuera
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
                
                // Navegaci√≥n con teclado
                input.addEventListener('keydown', (e) => {
                    const options = dropdown.querySelectorAll('.municipality-option');
                    const highlighted = dropdown.querySelector('.municipality-option.highlighted');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (highlighted) {
                            highlighted.classList.remove('highlighted');
                            const next = highlighted.nextElementSibling;
                            if (next) next.classList.add('highlighted');
                            else options[0]?.classList.add('highlighted');
                        } else {
                            options[0]?.classList.add('highlighted');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (highlighted) {
                            highlighted.classList.remove('highlighted');
                            const prev = highlighted.previousElementSibling;
                            if (prev) prev.classList.add('highlighted');
                            else options[options.length - 1]?.classList.add('highlighted');
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (highlighted) {
                            highlighted.click();
                        }
                    }
                });
            });
        }
        
        function selectMunicipality(prefix, id, name, dept) {
            document.getElementById(`${prefix}-municipality`).value = id;
            document.getElementById(`${prefix}-municipality-name`).textContent = `${name} - ${dept}`;
            document.getElementById(`${prefix}-municipality-selected`).style.display = 'flex';
            
            // Guardar selecci√≥n en localStorage
            selectedMunicipality = { id, name, dept };
            localStorage.setItem('selectedMunicipality', JSON.stringify(selectedMunicipality));
            
            // Sincronizar todos los selectores
            syncMunicipalitySelectors(prefix);
        }
        
        function clearMunicipalitySelection(prefix) {
            document.getElementById(`${prefix}-municipality`).value = '';
            document.getElementById(`${prefix}-municipality-selected`).style.display = 'none';
            document.getElementById(`${prefix}-municipality-search`).value = '';
        }
        
        function syncMunicipalitySelectors(sourcePrefix) {
            const prefixes = ['wl', 'act', 'fp'];
            prefixes.forEach(prefix => {
                if (prefix !== sourcePrefix && selectedMunicipality) {
                    document.getElementById(`${prefix}-municipality`).value = selectedMunicipality.id;
                    document.getElementById(`${prefix}-municipality-name`).textContent = 
                        `${selectedMunicipality.name} - ${selectedMunicipality.dept}`;
                    document.getElementById(`${prefix}-municipality-selected`).style.display = 'flex';
                }
            });
        }
        
        function restoreSelectedMunicipality() {
            const prefixes = ['wl', 'act', 'fp'];
            prefixes.forEach(prefix => {
                document.getElementById(`${prefix}-municipality`).value = selectedMunicipality.id;
                document.getElementById(`${prefix}-municipality-name`).textContent = 
                    `${selectedMunicipality.name} - ${selectedMunicipality.dept}`;
                document.getElementById(`${prefix}-municipality-selected`).style.display = 'flex';
            });
            
            // Cargar datos del municipio seleccionado
            loadWhiteLabelConfig(selectedMunicipality.id);
            loadActivities(selectedMunicipality.id);
            loadFormulaParameters(selectedMunicipality.id);
        }
        
        // ==================== VISTA PREVIA DE CONSECUTIVO/RADICADO ====================
        
        function updateSerialPreview() {
            const consecutivoPrefijo = document.getElementById('wl-consecutivo-prefijo').value;
            const consecutivoInicio = parseInt(document.getElementById('wl-consecutivo-inicio').value) || 1;
            const consecutivoDigitos = parseInt(document.getElementById('wl-consecutivo-digitos').value) || 12;
            
            const radicadoPrefijo = document.getElementById('wl-radicado-prefijo').value;
            const radicadoInicio = parseInt(document.getElementById('wl-radicado-inicio').value) || 1;
            const radicadoDigitos = parseInt(document.getElementById('wl-radicado-digitos').value) || 16;
            
            const consecutivoNum = consecutivoInicio.toString().padStart(consecutivoDigitos, '0');
            const radicadoNum = radicadoInicio.toString().padStart(radicadoDigitos, '0');
            
            document.getElementById('consecutivo-preview').textContent = consecutivoPrefijo + consecutivoNum;
            document.getElementById('radicado-preview').textContent = radicadoPrefijo + radicadoNum;
        }
        
        // Event listeners para vista previa
        ['wl-consecutivo-prefijo', 'wl-consecutivo-inicio', 'wl-consecutivo-digitos',
         'wl-radicado-prefijo', 'wl-radicado-inicio', 'wl-radicado-digitos'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateSerialPreview);
        });
        
        // ==================== FUNCIONES DE CARGA DE DATOS ====================
        
        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                document.getElementById('user-name').textContent = user.full_name;
                
                if (user.role !== 'admin_alcaldia' && user.role !== 'admin_sistema') {
                    alert('No tiene permisos para acceder a esta p√°gina');
                    window.location.href = 'dashboard.html';
                }
                
                // Mostrar link de super admin solo para admin_sistema
                if (user.role === 'admin_sistema') {
                    document.getElementById('superadmin-link').style.display = 'inline';
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        
        async function loadWhiteLabelConfig(municipalityId) {
            if (!municipalityId) return;
            
            try {
                const config = await AdminAPI.getWhiteLabelConfig(municipalityId);
                
                document.getElementById('wl-form-title').value = config.form_title || '';
                document.getElementById('wl-primary-color').value = config.primary_color || '#003366';
                document.getElementById('wl-secondary-color').value = config.secondary_color || '#0066CC';
                document.getElementById('wl-accent-color').value = config.accent_color || '#FF9900';
                document.getElementById('wl-font').value = config.font_family || 'Arial, sans-serif';
                document.getElementById('wl-header').value = config.header_text || '';
                document.getElementById('wl-legal').value = config.legal_notes || '';
                document.getElementById('wl-footer').value = config.footer_text || '';
                document.getElementById('wl-watermark').value = config.watermark_text || '';
                
                // Cargar configuraci√≥n de consecutivo y radicado
                document.getElementById('wl-consecutivo-prefijo').value = config.consecutivo_prefijo || '';
                document.getElementById('wl-consecutivo-inicio').value = config.consecutivo_actual || 1;
                document.getElementById('wl-consecutivo-digitos').value = config.consecutivo_digitos || 12;
                document.getElementById('wl-radicado-prefijo').value = config.radicado_prefijo || '';
                document.getElementById('wl-radicado-inicio').value = config.radicado_actual || 1;
                document.getElementById('wl-radicado-digitos').value = config.radicado_digitos || 16;
                
                updateSerialPreview();
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        async function loadActivities(municipalityId) {
            if (!municipalityId) {
                document.getElementById('activities-body').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center;">Seleccione un municipio</td></tr>';
                return;
            }
            
            try {
                const activities = await AdminAPI.listActivities(municipalityId);
                const tbody = document.getElementById('activities-body');
                
                if (activities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay actividades registradas</td></tr>';
                } else {
                    tbody.innerHTML = activities.map(a => `
                        <tr>
                            <td>${a.ciiu_code}</td>
                            <td>${a.description}</td>
                            <td>${a.tax_rate}‚Ä∞</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteActivity(${a.id})">
                                    Eliminar
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }
        
        async function loadFormulaParameters(municipalityId) {
            if (!municipalityId) return;
            
            try {
                const params = await AdminAPI.getFormulaParameters(municipalityId);
                
                document.getElementById('fp-avisos-tableros').value = params.avisos_tableros_porcentaje || 15;
                document.getElementById('fp-sobretasa-bomberil').value = params.sobretasa_bomberil_porcentaje || 0;
                document.getElementById('fp-sobretasa-seguridad').value = params.sobretasa_seguridad_porcentaje || 0;
                document.getElementById('fp-ley56-tarifa').value = params.ley_56_tarifa_por_kw || 0;
                document.getElementById('fp-unidades-financiero').value = params.unidades_adicionales_financiero_valor || 0;
                document.getElementById('fp-anticipo').value = params.anticipo_ano_siguiente_porcentaje || 40;
                document.getElementById('fp-descuento-pronto-pago').value = params.descuento_pronto_pago_porcentaje || 10;
                document.getElementById('fp-descuento-dias').value = params.descuento_pronto_pago_dias || 30;
                document.getElementById('fp-interes-mora').value = params.interes_mora_mensual || 1;
            } catch (error) {
                console.error('Error loading formula parameters:', error);
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        
        // Filtros de tabla
        document.getElementById('muni-filter-search').addEventListener('input', filterMunicipalities);
        document.getElementById('muni-filter-dept').addEventListener('change', filterMunicipalities);
        
        // Paginaci√≥n
        document.getElementById('muni-prev').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderMunicipalitiesTable();
            }
        });
        
        document.getElementById('muni-next').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredMunicipalities.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderMunicipalitiesTable();
            }
        });
        
        // Formulario de par√°metros de f√≥rmulas
        document.getElementById('formula-params-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const municipalityId = document.getElementById('fp-municipality').value;
            if (!municipalityId) {
                alert('Seleccione un municipio');
                return;
            }
            
            try {
                showLoading();
                
                const params = {
                    avisos_tableros_porcentaje: parseFloat(document.getElementById('fp-avisos-tableros').value) || 15,
                    sobretasa_bomberil_porcentaje: parseFloat(document.getElementById('fp-sobretasa-bomberil').value) || 0,
                    sobretasa_seguridad_porcentaje: parseFloat(document.getElementById('fp-sobretasa-seguridad').value) || 0,
                    ley_56_tarifa_por_kw: parseFloat(document.getElementById('fp-ley56-tarifa').value) || 0,
                    unidades_adicionales_financiero_valor: parseFloat(document.getElementById('fp-unidades-financiero').value) || 0,
                    anticipo_ano_siguiente_porcentaje: parseFloat(document.getElementById('fp-anticipo').value) || 40,
                    descuento_pronto_pago_porcentaje: parseFloat(document.getElementById('fp-descuento-pronto-pago').value) || 10,
                    descuento_pronto_pago_dias: parseInt(document.getElementById('fp-descuento-dias').value) || 30,
                    interes_mora_mensual: parseFloat(document.getElementById('fp-interes-mora').value) || 1
                };
                
                await AdminAPI.updateFormulaParameters(municipalityId, params);
                
                hideLoading();
                alert('‚úÖ Par√°metros de f√≥rmulas actualizados correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // Formulario de configuraci√≥n marca blanca
        document.getElementById('white-label-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const municipalityId = document.getElementById('wl-municipality').value;
            if (!municipalityId) {
                alert('Seleccione un municipio');
                return;
            }
            
            try {
                showLoading();
                
                const config = {
                    form_title: document.getElementById('wl-form-title').value,
                    primary_color: document.getElementById('wl-primary-color').value,
                    secondary_color: document.getElementById('wl-secondary-color').value,
                    accent_color: document.getElementById('wl-accent-color').value,
                    font_family: document.getElementById('wl-font').value,
                    header_text: document.getElementById('wl-header').value,
                    legal_notes: document.getElementById('wl-legal').value,
                    footer_text: document.getElementById('wl-footer').value,
                    watermark_text: document.getElementById('wl-watermark').value,
                    // Configuraci√≥n de numeraci√≥n
                    consecutivo_prefijo: document.getElementById('wl-consecutivo-prefijo').value,
                    consecutivo_actual: parseInt(document.getElementById('wl-consecutivo-inicio').value) || 1,
                    consecutivo_digitos: parseInt(document.getElementById('wl-consecutivo-digitos').value) || 12,
                    radicado_prefijo: document.getElementById('wl-radicado-prefijo').value,
                    radicado_actual: parseInt(document.getElementById('wl-radicado-inicio').value) || 1,
                    radicado_digitos: parseInt(document.getElementById('wl-radicado-digitos').value) || 16
                };
                
                await AdminAPI.updateWhiteLabelConfig(municipalityId, config);
                
                // Subir logo si se seleccion√≥
                const logoInput = document.getElementById('wl-logo');
                if (logoInput.files.length > 0) {
                    await AdminAPI.uploadLogo(municipalityId, logoInput.files[0]);
                }
                
                hideLoading();
                alert('‚úÖ Configuraci√≥n guardada correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // Formulario de actividades
        document.getElementById('activity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const municipalityId = document.getElementById('act-municipality').value;
            if (!municipalityId) {
                alert('Seleccione un municipio');
                return;
            }
            
            try {
                showLoading();
                
                await AdminAPI.createActivity({
                    municipality_id: parseInt(municipalityId),
                    ciiu_code: document.getElementById('act-ciiu').value,
                    description: document.getElementById('act-description').value,
                    tax_rate: parseFloat(document.getElementById('act-rate').value)
                });
                
                document.getElementById('act-ciiu').value = '';
                document.getElementById('act-description').value = '';
                document.getElementById('act-rate').value = '4.14';
                
                loadActivities(municipalityId);
                
                hideLoading();
                alert('‚úÖ Actividad creada correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        });
        
        // (Formulario de creaci√≥n de municipios eliminado - todos los municipios ya est√°n precargados)
        
        // ==================== FUNCIONES AUXILIARES ====================
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        
        async function deleteActivity(activityId) {
            if (!confirm('¬øEst√° seguro de eliminar esta actividad?')) {
                return;
            }
            
            try {
                showLoading();
                await AdminAPI.deleteActivity(activityId);
                
                const municipalityId = document.getElementById('act-municipality').value;
                if (municipalityId) {
                    loadActivities(municipalityId);
                }
                
                hideLoading();
                alert('‚úÖ Actividad eliminada correctamente');
            } catch (error) {
                hideLoading();
                alert('Error: ' + error.message);
            }
        }
        
        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await AuthAPI.logout();
            localStorage.removeItem('selectedMunicipality');
            window.location.href = 'login.html';
        });
        
        // ==================== INICIALIZACI√ìN ====================
        loadUserData();
        loadMunicipalities();
        updateSerialPreview();
    </script>
</body>
</html>
