<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Formulario √önico Nacional de Declaraci√≥n y Pago ICA">
    <title>Formulario ICA - Sistema de Declaraci√≥n</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <span class="logo-text">Sistema ICA</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html">Inicio</a></li>
                    <li><a href="form.html" class="active">Declaraci√≥n</a></li>
                </ul>
            </nav>
            
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-outline" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div id="alert-container"></div>
            
            <form id="ica-form">
                <!-- Encabezado del Formulario -->
                <div class="card">
                    <div class="card-header">
                        üìã Formulario √önico Nacional de Declaraci√≥n y Pago ICA
                    </div>
                    <div class="card-body">
                        <p><small>Basado en: Documents/formulario-ICA.md</small></p>
                        
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="form_number" class="form-label">No. Formulario</label>
                                    <input type="text" id="form_number" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="tax_year" class="form-label required">A√±o Gravable</label>
                                    <input type="number" id="tax_year" class="form-control" 
                                           min="2000" max="2100" required>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="declaration_type" class="form-label required">Tipo de Declaraci√≥n</label>
                                    <select id="declaration_type" class="form-control" required>
                                        <option value="inicial">Declaraci√≥n Inicial</option>
                                        <option value="correccion">Correcci√≥n</option>
                                        <option value="correccion_disminuye">Correcci√≥n que disminuye valor</option>
                                        <option value="correccion_aumenta">Correcci√≥n que aumenta valor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="municipality_id" class="form-label required">Municipio</label>
                                    <select id="municipality_id" class="form-control" required>
                                        <option value="">Seleccione...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n A - Informaci√≥n del Contribuyente -->
                <div class="card">
                    <div class="card-header">
                        üìù Secci√≥n A ‚Äì Informaci√≥n del Contribuyente
                    </div>
                    <div class="card-body">
                        <h4>Identificaci√≥n</h4>
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="document_type" class="form-label required">Tipo de Documento</label>
                                    <select id="document_type" class="form-control" required>
                                        <option value="">Seleccione...</option>
                                        <option value="CC">C√©dula de Ciudadan√≠a</option>
                                        <option value="CE">C√©dula de Extranjer√≠a</option>
                                        <option value="NIT">NIT</option>
                                        <option value="PAS">Pasaporte</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="document_number" class="form-label required">N√∫mero de Documento / NIT</label>
                                    <input type="text" id="document_number" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label for="verification_digit" class="form-label">DV</label>
                                    <input type="text" id="verification_digit" class="form-control" maxlength="1">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="legal_name" class="form-label required">Raz√≥n Social / Nombre</label>
                                    <input type="text" id="legal_name" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="margin-top: 1rem;">Ubicaci√≥n</h4>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="address" class="form-label">Direcci√≥n</label>
                                    <input type="text" id="address" class="form-control">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="taxpayer_municipality" class="form-label">Municipio</label>
                                    <input type="text" id="taxpayer_municipality" class="form-control">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="taxpayer_department" class="form-label">Departamento</label>
                                    <input type="text" id="taxpayer_department" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="phone" class="form-label">Tel√©fono</label>
                                    <input type="tel" id="phone" class="form-control">
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="email" class="form-label">Correo Electr√≥nico</label>
                                    <input type="email" id="email" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n B - Base Gravable -->
                <div class="card">
                    <div class="card-header">
                        üí∞ Secci√≥n B ‚Äì Base Gravable
                    </div>
                    <div class="card-body">
                        <p class="form-text">
                            Complete los renglones 8-15. Los renglones 10 y 16 se calculan autom√°ticamente.
                        </p>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">8</div>
                            <div class="ica-row-label">Total ingresos ordinarios</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_8" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">9</div>
                            <div class="ica-row-label">Ingresos extraordinarios</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_9" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">10</div>
                            <div class="ica-row-label"><strong>TOTAL INGRESOS</strong> (Calculado: R8 + R9)</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_10" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">11</div>
                            <div class="ica-row-label">Devoluciones</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_11" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">12</div>
                            <div class="ica-row-label">Exportaciones</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_12" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">13</div>
                            <div class="ica-row-label">Ventas de activos fijos</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_13" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">14</div>
                            <div class="ica-row-label">Ingresos excluidos</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_14" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">15</div>
                            <div class="ica-row-label">Ingresos no gravados</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_15" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">16</div>
                            <div class="ica-row-label">
                                <strong>TOTAL INGRESOS GRAVABLES</strong>
                                <br><small>(Calculado: R10 - (R11 + R12 + R13 + R14 + R15))</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_16" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n C - Actividades Gravadas -->
                <div class="card">
                    <div class="card-header">
                        üìä Secci√≥n C ‚Äì Actividades Gravadas
                    </div>
                    <div class="card-body">
                        <p class="form-text">
                            Agregue las actividades econ√≥micas con su c√≥digo CIIU, ingresos y tarifa ICA (en ‚Ä∞).
                        </p>
                        
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>C√≥digo CIIU</th>
                                    <th>Descripci√≥n</th>
                                    <th>Ingresos</th>
                                    <th>Tarifa (‚Ä∞)</th>
                                    <th>Impuesto</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="activities-container">
                                <!-- Actividades din√°micas -->
                            </tbody>
                            <tfoot>
                                <tr class="table-total">
                                    <td colspan="4" style="text-align: right;">
                                        <strong>TOTAL IMPUESTO POR ACTIVIDADES:</strong>
                                    </td>
                                    <td id="total-activities-tax">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <button type="button" class="btn btn-secondary" id="btn-add-activity">
                            + Agregar Actividad
                        </button>
                    </div>
                </div>
                
                <!-- Secci√≥n D - Liquidaci√≥n -->
                <div class="card">
                    <div class="card-header">
                        üìë Secci√≥n D ‚Äì Liquidaci√≥n del Impuesto
                    </div>
                    <div class="card-body">
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">30</div>
                            <div class="ica-row-label"><strong>Impuesto de Industria y Comercio</strong> (Suma de actividades)</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_30" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">31</div>
                            <div class="ica-row-label">Avisos y Tableros</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_31" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">32</div>
                            <div class="ica-row-label">Sobretasa</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_32" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">33</div>
                            <div class="ica-row-label"><strong>TOTAL IMPUESTO</strong> (Calculado: R30 + R31 + R32)</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_33" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n E - Descuentos -->
                <div class="card">
                    <div class="card-header">
                        üí≥ Secci√≥n E ‚Äì Descuentos, Cr√©ditos y Anticipos
                    </div>
                    <div class="card-body">
                        <div class="ica-row">
                            <div class="ica-row-number"></div>
                            <div class="ica-row-label">Descuentos tributarios</div>
                            <div class="ica-row-value">
                                <input type="number" id="tax_discounts" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number"></div>
                            <div class="ica-row-label">Anticipos pagados</div>
                            <div class="ica-row-value">
                                <input type="number" id="advance_payments" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number"></div>
                            <div class="ica-row-label">Retenciones sufridas</div>
                            <div class="ica-row-value">
                                <input type="number" id="withholdings" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number"></div>
                            <div class="ica-row-label"><strong>TOTAL CR√âDITOS</strong></div>
                            <div class="ica-row-value">
                                <input type="number" id="total_credits" class="form-control" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n F - Resultado -->
                <div class="card">
                    <div class="card-header">
                        üíµ Secci√≥n F ‚Äì Total a Pagar / Saldo a Favor
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>Nota:</strong> Solo uno de estos campos tendr√° valor. Si el impuesto es mayor que los cr√©ditos, 
                            habr√° valor a pagar. Si los cr√©ditos son mayores, habr√° saldo a favor.
                        </div>
                        
                        <div class="row">
                            <div class="col-6" id="amount_to_pay_container">
                                <div class="form-group">
                                    <label for="amount_to_pay" class="form-label"><strong>Total a Pagar</strong></label>
                                    <input type="number" id="amount_to_pay" class="form-control" readonly 
                                           style="font-size: 1.5rem; font-weight: bold; color: var(--danger-color);">
                                </div>
                            </div>
                            <div class="col-6" id="balance_in_favor_container">
                                <div class="form-group">
                                    <label for="balance_in_favor" class="form-label"><strong>Saldo a Favor</strong></label>
                                    <input type="number" id="balance_in_favor" class="form-control" readonly
                                           style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones del Formulario -->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    üíæ Guardar Declaraci√≥n
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" id="btn-calculate">
                                    üîÑ Recalcular
                                </button>
                            </div>
                            <div class="col-6" style="text-align: right;">
                                <button type="button" class="btn btn-success btn-lg" id="btn-open-signature">
                                    ‚úçÔ∏è Firmar Declaraci√≥n
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" id="btn-generate-pdf">
                                    üìÑ Generar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>
    
    <!-- Modal de Firma -->
    <div id="signature-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">‚úçÔ∏è Secci√≥n G ‚Äì Firma y Responsabilidad</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Atenci√≥n:</strong> Una vez firmada la declaraci√≥n, no podr√° ser modificada.
                </div>
                
                <div class="form-group">
                    <label for="declarant_name" class="form-label required">Nombre del Declarante</label>
                    <input type="text" id="declarant_name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="declaration_date" class="form-label required">Fecha de Declaraci√≥n</label>
                    <input type="date" id="declaration_date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="accountant_name" class="form-label">Nombre Contador / Revisor Fiscal</label>
                    <input type="text" id="accountant_name" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="professional_card" class="form-label">N√∫mero de Tarjeta Profesional</label>
                    <input type="text" id="professional_card" class="form-control">
                </div>
                
                <div class="form-group">
                    <label class="form-label required">Firma Digital</label>
                    <p class="form-text">Dibuje su firma en el recuadro a continuaci√≥n:</p>
                    <div class="signature-container">
                        <canvas id="signature-canvas" class="signature-canvas"></canvas>
                    </div>
                    <div class="signature-actions">
                        <button type="button" class="btn btn-outline" id="btn-clear-signature">
                            Limpiar Firma
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirm-signature">
                    ‚úÖ Confirmar y Firmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema ICA - Formulario √önico Nacional de Declaraci√≥n y Pago</p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script src="../js/api.js"></script>
    <script src="../js/ica-form.js"></script>
    <script src="../js/signature.js"></script>
    <script>
        // Verificar autenticaci√≥n
        if (!AuthAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // Obtener ID de declaraci√≥n de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const declarationId = urlParams.get('id');
        
        // Cargar datos del usuario
        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                document.getElementById('user-name').textContent = user.full_name;
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        
        // Cargar municipios
        async function loadMunicipalities() {
            try {
                const municipalities = await AdminAPI.listMunicipalities();
                const select = document.getElementById('municipality_id');
                
                municipalities.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.textContent = `${m.name} - ${m.department}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading municipalities:', error);
            }
        }
        
        // Inicializar formulario
        function initializeForm() {
            // Establecer a√±o actual por defecto
            document.getElementById('tax_year').value = new Date().getFullYear();
            
            // Establecer fecha actual para firma
            document.getElementById('declaration_date').value = 
                new Date().toISOString().split('T')[0];
            
            // Inicializar controlador de formulario
            const form = document.getElementById('ica-form');
            formController = new ICAFormController(form, declarationId ? parseInt(declarationId) : null);
            
            // Inicializar modal de firma
            const signatureModal = new SignatureModal('signature-modal', 'signature-canvas', {
                declarationId: declarationId ? parseInt(declarationId) : null,
                onSign: (data) => {
                    console.log('Declaraci√≥n firmada:', data);
                }
            });
        }
        
        // Bot√≥n recalcular
        document.getElementById('btn-calculate').addEventListener('click', () => {
            if (formController) {
                formController.recalculate();
                showAlert('Valores recalculados', 'success');
            }
        });
        
        // Bot√≥n generar PDF
        document.getElementById('btn-generate-pdf').addEventListener('click', async () => {
            if (!formController || !formController.declarationId) {
                showAlert('Primero debe guardar la declaraci√≥n', 'warning');
                return;
            }
            
            try {
                showLoading();
                await DeclarationsAPI.generatePDF(formController.declarationId);
                hideLoading();
                showAlert('PDF generado correctamente. Puede descargarlo desde el panel de control.', 'success');
            } catch (error) {
                hideLoading();
                showAlert('Error al generar PDF: ' + error.message, 'danger');
            }
        });
        
        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await AuthAPI.logout();
            window.location.href = 'login.html';
        });
        
        // Inicializar
        loadUserData();
        loadMunicipalities();
        initializeForm();
    </script>
</body>
</html>
