<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Formulario √önico Nacional de Declaraci√≥n y Pago ICA">
    <title>Formulario ICA - Sistema de Declaraci√≥n</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <span class="logo-text">üèõÔ∏è Sistema ICA</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html">Inicio</a></li>
                    <li><a href="form.html" class="active">Declaraci√≥n</a></li>
                </ul>
            </nav>
            
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-outline" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div id="alert-container"></div>
            
            <form id="ica-form">
                <!-- ENCABEZADO DEL FORMULARIO -->
                <div class="card">
                    <div class="card-header">
                        üìã FORMULARIO √öNICO NACIONAL DE DECLARACI√ìN Y PAGO DEL IMPUESTO DE INDUSTRIA Y COMERCIO
                    </div>
                    <div class="card-body">
                        <p class="form-text mb-2">
                            <small>Basado en: Documents/formulario-ICA.md - Fuente oficial para el formulario ICA</small>
                        </p>
                        
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label for="form_number" class="form-label">No. Formulario</label>
                                    <input type="text" id="form_number" class="form-control" readonly placeholder="Auto-generado">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="municipality_id" class="form-label required">Municipio o Distrito</label>
                                    <select id="municipality_id" class="form-control" required>
                                        <option value="">Seleccione...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="department" class="form-label required">Departamento</label>
                                    <select id="department" class="form-control" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Amazonas">Amazonas</option>
                                        <option value="Antioquia">Antioquia</option>
                                        <option value="Arauca">Arauca</option>
                                        <option value="Atl√°ntico">Atl√°ntico</option>
                                        <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                                        <option value="Bol√≠var">Bol√≠var</option>
                                        <option value="Boyac√°">Boyac√°</option>
                                        <option value="Caldas">Caldas</option>
                                        <option value="Caquet√°">Caquet√°</option>
                                        <option value="Casanare">Casanare</option>
                                        <option value="Cauca">Cauca</option>
                                        <option value="Cesar">Cesar</option>
                                        <option value="Choc√≥">Choc√≥</option>
                                        <option value="C√≥rdoba">C√≥rdoba</option>
                                        <option value="Cundinamarca">Cundinamarca</option>
                                        <option value="Guain√≠a">Guain√≠a</option>
                                        <option value="Guaviare">Guaviare</option>
                                        <option value="Huila">Huila</option>
                                        <option value="La Guajira">La Guajira</option>
                                        <option value="Magdalena">Magdalena</option>
                                        <option value="Meta">Meta</option>
                                        <option value="Nari√±o">Nari√±o</option>
                                        <option value="Norte de Santander">Norte de Santander</option>
                                        <option value="Putumayo">Putumayo</option>
                                        <option value="Quind√≠o">Quind√≠o</option>
                                        <option value="Risaralda">Risaralda</option>
                                        <option value="San Andr√©s y Providencia">San Andr√©s y Providencia</option>
                                        <option value="Santander">Santander</option>
                                        <option value="Sucre">Sucre</option>
                                        <option value="Tolima">Tolima</option>
                                        <option value="Valle del Cauca">Valle del Cauca</option>
                                        <option value="Vaup√©s">Vaup√©s</option>
                                        <option value="Vichada">Vichada</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label for="tax_year" class="form-label required">A√±o Gravable</label>
                                    <input type="number" id="tax_year" class="form-control" min="2000" max="2100" required>
                                </div>
                            </div>
                            <div class="col-2">
                                <div class="form-group">
                                    <label for="max_filing_date" class="form-label">Fecha M√°x. Presentaci√≥n</label>
                                    <input type="date" id="max_filing_date" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Uso exclusivo Bogot√° -->
                        <div class="info-box mt-2" id="bogota-section" style="display: none;">
                            <div class="info-box-title">üìç Uso exclusivo Bogot√° D.C.</div>
                            <div class="row mt-1">
                                <div class="col-4">
                                    <div class="form-group mb-0">
                                        <label for="bogota_period" class="form-label">Bimestre / Periodo</label>
                                        <select id="bogota_period" class="form-control">
                                            <option value="">Seleccione periodo...</option>
                                            <option value="ene-feb">Enero - Febrero</option>
                                            <option value="mar-abr">Marzo - Abril</option>
                                            <option value="may-jun">Mayo - Junio</option>
                                            <option value="jul-ago">Julio - Agosto</option>
                                            <option value="sep-oct">Septiembre - Octubre</option>
                                            <option value="nov-dic">Noviembre - Diciembre</option>
                                            <option value="anual">Anual</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="divider">

                        <!-- OPCI√ìN DE USO DEL FORMULARIO -->
                        <div class="section-title">OPCI√ìN DE USO DEL FORMULARIO</div>
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="declaration_type" class="form-label required">Tipo de Declaraci√≥n</label>
                                    <select id="declaration_type" class="form-control" required>
                                        <option value="inicial">Declaraci√≥n Inicial</option>
                                        <option value="correccion">Declaraci√≥n que Corrige</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3" id="correction-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="corrected_form_number" class="form-label">No. Formulario Corregido</label>
                                    <input type="text" id="corrected_form_number" class="form-control" placeholder="Ej: ICA-2024-0001">
                                </div>
                            </div>
                            <div class="col-3" id="correction-date-field" style="display: none;">
                                <div class="form-group">
                                    <label for="correction_date" class="form-label">Fecha (dd/mm/aaaa)</label>
                                    <input type="date" id="correction_date" class="form-control">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN A - INFORMACI√ìN DEL CONTRIBUYENTE -->
                <div class="card">
                    <div class="card-header">
                        üë§ SECCI√ìN A ‚Äì INFORMACI√ìN DEL CONTRIBUYENTE
                    </div>
                    <div class="card-body">
                        <!-- Indicador de campos autocompletados -->
                        <div class="alert alert-info" style="margin-bottom: 1rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left: 4px solid #0284c7;">
                            <strong>üìã Campos Autocompletados:</strong> Los datos del contribuyente se han rellenado autom√°ticamente 
                            con la informaci√≥n de su registro. Estos campos son <strong>OBLIGATORIOS</strong> por convenci√≥n institucional 
                            nacional y deben ser verificados antes de enviar la declaraci√≥n.
                        </div>
                        
                        <!-- Rengl√≥n 1: Nombres y apellidos o raz√≥n social -->
                        <div class="section-title">1. Apellidos y nombres / Raz√≥n social</div>
                        <div class="row">
                            <div class="col-9">
                                <div class="form-group">
                                    <label for="legal_name" class="form-label required">Nombres y Apellidos o Raz√≥n Social</label>
                                    <input type="text" id="legal_name" class="form-control" required placeholder="Ingrese nombre completo o raz√≥n social"
                                           style="background-color: #f0fdf4;">
                                    <small class="form-text" style="color: #059669;">‚úì Campo obligatorio - autocompletado desde registro</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="entity_type" class="form-label required">Tipo de entidad</label>
                                    <select id="entity_type" class="form-control" required>
                                        <option value="privada">Privada</option>
                                        <option value="publica">P√∫blica</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 2: C√©dula o NIT -->
                        <div class="section-title">2. C√©dula o NIT</div>
                        <div class="row">
                            <div class="col-2">
                                <div class="form-group">
                                    <label for="document_type" class="form-label required">Tipo Documento</label>
                                    <select id="document_type" class="form-control" required style="background-color: #f0fdf4;">
                                        <option value="">Seleccione...</option>
                                        <option value="CC">CC - C√©dula de Ciudadan√≠a</option>
                                        <option value="NIT">NIT - N√∫mero de Identificaci√≥n Tributaria</option>
                                        <option value="TI">TI - Tarjeta de Identidad</option>
                                        <option value="CE">CE - C√©dula de Extranjer√≠a</option>
                                        <option value="PAS">PAS - Pasaporte</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="document_number" class="form-label required">N√∫mero de Documento</label>
                                    <input type="text" id="document_number" class="form-control" required placeholder="Ej: 1234567890"
                                           style="background-color: #f0fdf4;">
                                    <small class="form-text" style="color: #059669;">‚úì Obligatorio</small>
                                </div>
                            </div>
                            <div class="col-1">
                                <div class="form-group">
                                    <label for="verification_digit" class="form-label">DV</label>
                                    <input type="text" id="verification_digit" class="form-control" maxlength="1" placeholder="0"
                                           style="background-color: #f0fdf4;">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="is_consortium" class="form-label">¬øConsorcio o Uni√≥n Temporal?</label>
                                    <select id="is_consortium" class="form-control">
                                        <option value="no">No</option>
                                        <option value="si">S√≠</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="autonomous_patrimony" class="form-label">¬øPatrimonio Aut√≥nomo?</label>
                                    <select id="autonomous_patrimony" class="form-control">
                                        <option value="no">No</option>
                                        <option value="si">S√≠</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 3: Direcci√≥n de notificaci√≥n -->
                        <div class="section-title">3. Direcci√≥n de notificaci√≥n</div>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="address" class="form-label required">Direcci√≥n</label>
                                    <input type="text" id="address" class="form-control" required placeholder="Direcci√≥n completa para notificaciones"
                                           style="background-color: #f0fdf4;">
                                    <small class="form-text" style="color: #059669;">‚úì Obligatorio</small>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="taxpayer_department" class="form-label required">Departamento</label>
                                    <input type="text" id="taxpayer_department" class="form-control" required placeholder="Departamento"
                                           style="background-color: #f0fdf4;">
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="taxpayer_municipality" class="form-label required">Municipio</label>
                                    <input type="text" id="taxpayer_municipality" class="form-control" required placeholder="Municipio"
                                           style="background-color: #f0fdf4;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 4: Tel√©fono -->
                        <div class="section-title">4. Tel√©fono</div>
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="phone" class="form-label required">Tel√©fono</label>
                                    <input type="tel" id="phone" class="form-control" required placeholder="Ej: 3001234567"
                                           style="background-color: #f0fdf4;">
                                    <small class="form-text" style="color: #059669;">‚úì Obligatorio</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 5: Correo electr√≥nico -->
                        <div class="section-title">5. Correo electr√≥nico</div>
                        <div class="row">
                            <div class="col-5">
                                <div class="form-group">
                                    <label for="email" class="form-label required">Correo Electr√≥nico</label>
                                    <input type="email" id="email" class="form-control" required autocomplete="email" placeholder="correo@ejemplo.com"
                                           style="background-color: #f0fdf4;">
                                    <small class="form-text" style="color: #059669;">‚úì Obligatorio</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 6: N√∫mero de establecimientos -->
                        <div class="section-title">6. N√∫mero de establecimientos en el municipio</div>
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="num_establishments" class="form-label">N√∫mero de Establecimientos</label>
                                    <input type="number" id="num_establishments" class="form-control" min="0" value="1" placeholder="1">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 7: Clasificaci√≥n del contribuyente -->
                        <div class="section-title">7. Clasificaci√≥n del contribuyente</div>
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="taxpayer_classification" class="form-label">Clasificaci√≥n</label>
                                    <select id="taxpayer_classification" class="form-control">
                                        <option value="comun">Com√∫n</option>
                                        <option value="simplificado">Simplificado</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN B - BASE GRAVABLE -->
                <div class="card">
                    <div class="card-header">
                        üí∞ SECCI√ìN B ‚Äì BASE GRAVABLE
                    </div>
                    <div class="card-body">
                        <p class="form-text mb-2">
                            Complete los renglones 8-15 seg√∫n el formulario oficial ICA.
                        </p>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">8</div>
                            <div class="ica-row-label">Total ingresos ordinarios y extraordinarios del per√≠odo en todo el pa√≠s</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_8" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">9</div>
                            <div class="ica-row-label">Menos ingresos fuera del municipio</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_9" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">10</div>
                            <div class="ica-row-label">
                                <strong>Total ingresos ordinarios y extraordinarios en el municipio</strong>
                                <small>(Calculado: Rengl√≥n 8 ‚àí 9)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_10" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">11</div>
                            <div class="ica-row-label">Menos ingresos por devoluciones, rebajas y descuentos</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_11" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">12</div>
                            <div class="ica-row-label">Menos ingresos por exportaciones y venta de activos fijos</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_12" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">13</div>
                            <div class="ica-row-label">Menos ingresos por actividades excluidas o no sujetas y otros ingresos no gravados</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_13" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">14</div>
                            <div class="ica-row-label">Menos ingresos por actividades exentas en el municipio</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_14" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">15</div>
                            <div class="ica-row-label">
                                <strong>Total ingresos gravables</strong>
                                <small>(Calculado: Rengl√≥n 10 ‚àí (11 + 12 + 13 + 14))</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_15" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <!-- Verificaci√≥n Secci√≥n C -->
                        <div id="section-c-verification" class="alert" style="margin-top: 1rem; display: none;">
                            <div id="verification-content"></div>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN C - DISCRIMINACI√ìN DE INGRESOS GRAVADOS Y ACTIVIDADES -->
                <div class="card">
                    <div class="card-header">
                        üìä SECCI√ìN C ‚Äì DISCRIMINACI√ìN DE INGRESOS GRAVADOS Y ACTIVIDADES
                    </div>
                    <div class="card-body">
                        <p class="form-text mb-2">
                            Agregue las actividades econ√≥micas con su c√≥digo CIIU, descripci√≥n, ingresos gravados, tarifa (en ‚Ä∞) e impuesto ICA.
                        </p>
                        
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">Tipo</th>
                                    <th style="width: 100px;">C√≥digo CIIU</th>
                                    <th>Descripci√≥n</th>
                                    <th style="width: 140px;">Ingresos Gravados</th>
                                    <th style="width: 90px;">Tarifa (‚Ä∞)</th>
                                    <th style="width: 140px;">Impuesto ICA</th>
                                    <th style="width: 90px;">Tarifa Esp.</th>
                                    <th style="width: 70px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="activities-container">
                                <!-- Actividades din√°micas -->
                            </tbody>
                            <tfoot>
                                <tr class="table-total">
                                    <td colspan="3" class="text-right">
                                        <strong>16. Total ingresos gravados en el municipio:</strong>
                                    </td>
                                    <td id="total-taxed-income">$0.00</td>
                                    <td colspan="2" class="text-right">
                                        <strong>17. Total impuesto ICA:</strong>
                                    </td>
                                    <td id="total-activities-tax">$0.00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <button type="button" class="btn btn-ghost" id="btn-add-activity">
                            ‚ûï Agregar Actividad
                        </button>
                        
                        <hr class="divider">
                        
                        <!-- Generaci√≥n de Energ√≠a - Ley 56 de 1981 -->
                        <div class="section-title">Generaci√≥n de Energ√≠a - Ley 56 de 1981</div>
                        <div class="row">
                            <div class="col-6">
                                <div class="ica-row">
                                    <div class="ica-row-number">18</div>
                                    <div class="ica-row-label">Generaci√≥n de energ√≠a ‚Äì Capacidad instalada (kW)</div>
                                    <div class="ica-row-value">
                                        <input type="number" id="row_18_energy_kw" class="form-control" min="0" step="0.01" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="ica-row calculated-field">
                                    <div class="ica-row-number">19</div>
                                    <div class="ica-row-label">
                                        <strong>Impuesto Ley 56 de 1981</strong>
                                    </div>
                                    <div class="ica-row-value">
                                        <input type="number" id="row_19_law56" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN D - LIQUIDACI√ìN DEL IMPUESTO -->
                <div class="card">
                    <div class="card-header">
                        üìë SECCI√ìN D ‚Äì LIQUIDACI√ìN DEL IMPUESTO
                    </div>
                    <div class="card-body">
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">20</div>
                            <div class="ica-row-label">
                                <strong>Total impuesto de industria y comercio</strong>
                                <small>(Calculado: Rengl√≥n 17 + 19)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_20" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <div class="ica-row" id="row_21_container">
                            <div class="ica-row-number">21</div>
                            <div class="ica-row-label">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span>Impuesto de avisos y tableros</span>
                                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: normal; cursor: pointer;">
                                        <input type="checkbox" id="uses_signs_boards" style="width: auto; margin: 0;">
                                        <span style="font-size: 0.875rem; color: #4b5563;">¬øUsa avisos y tableros en el municipio?</span>
                                    </label>
                                </div>
                                <small id="row_21_formula" style="color: #6b7280; display: none;">
                                    (Calculado: Rengl√≥n 20 √ó <span id="avisos_rate_display">15</span>%)
                                </small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_21" class="form-control" min="0" step="0.01" value="0" readonly 
                                       style="background-color: #f3f4f6;">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">22</div>
                            <div class="ica-row-label">Pago por unidades comerciales adicionales del sector financiero</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_22" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">23</div>
                            <div class="ica-row-label">Sobretasa bomberil</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_23" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">24</div>
                            <div class="ica-row-label">Sobretasa de seguridad</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_24" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">25</div>
                            <div class="ica-row-label">
                                <strong>Total impuesto a cargo</strong>
                                <small>(Calculado: 20 + 21 + 22 + 23 + 24)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_25" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <hr class="divider">
                        
                        <div class="ica-row">
                            <div class="ica-row-number">26</div>
                            <div class="ica-row-label">Menos exenciones o exoneraciones sobre el impuesto</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_26" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">27</div>
                            <div class="ica-row-label">Menos retenciones practicadas en el municipio</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_27" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">28</div>
                            <div class="ica-row-label">Menos autorretenciones practicadas en el municipio</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_28" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">29</div>
                            <div class="ica-row-label">Menos anticipo liquidado en el a√±o anterior</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_29" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">30</div>
                            <div class="ica-row-label">Anticipo del a√±o siguiente</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_30" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">31</div>
                            <div class="ica-row-label">
                                Sanciones
                                <select id="row_31_type" class="form-control" style="display: inline-block; width: 200px; margin-left: 10px;">
                                    <option value="">Sin sanci√≥n</option>
                                    <option value="extemporaneidad">Extemporaneidad</option>
                                    <option value="correccion">Correcci√≥n</option>
                                    <option value="inexactitud">Inexactitud</option>
                                    <option value="otra">Otra</option>
                                </select>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_31" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">32</div>
                            <div class="ica-row-label">Menos saldo a favor del per√≠odo anterior</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_32" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <hr class="divider">
                        
                        <!-- Rengl√≥n 33: Total saldo a cargo (lo que debe el contribuyente) -->
                        <div class="ica-row" id="row_33_container" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid var(--danger-color);">
                            <div class="ica-row-number" style="background: rgba(239, 68, 68, 0.2); color: var(--danger-color);">33</div>
                            <div class="ica-row-label">
                                <strong>Total saldo a cargo</strong>
                                <small style="color: #dc2626;">(Si este valor es mayor a 0, el contribuyente DEBE pagar)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_33" class="form-control" readonly 
                                       style="font-size: 1.25rem; font-weight: 700; color: var(--danger-color);">
                            </div>
                        </div>
                        
                        <!-- Rengl√≥n 34: Total saldo a favor (lo que le deben al contribuyente) -->
                        <div class="ica-row" id="row_34_container" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid var(--success-color); margin-top: 0.5rem;">
                            <div class="ica-row-number" style="background: rgba(16, 185, 129, 0.2); color: var(--success-color);">34</div>
                            <div class="ica-row-label">
                                <strong>Total saldo a favor</strong>
                                <small style="color: #059669;">(Si este valor es mayor a 0, la alcald√≠a DEBE al contribuyente)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_34" class="form-control" readonly
                                       style="font-size: 1.25rem; font-weight: 700; color: var(--success-color);">
                            </div>
                        </div>
                        
                        <!-- Indicador visual del resultado -->
                        <div id="balance-result-indicator" class="alert" style="margin-top: 1rem; display: none;">
                        </div>
                    </div>
                </div>
                
                <!-- SECCI√ìN E - PAGO -->
                <div class="card">
                    <div class="card-header">
                        üíµ SECCI√ìN E ‚Äì PAGO
                    </div>
                    <div class="card-body">
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">35</div>
                            <div class="ica-row-label">
                                <strong>Valor a pagar</strong>
                                <small>(Autocompletado desde Rengl√≥n 33 - Saldo a cargo)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_35" class="form-control" readonly style="background-color: #f3f4f6;">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">36</div>
                            <div class="ica-row-label">Descuento por pronto pago</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_36" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row">
                            <div class="ica-row-number">37</div>
                            <div class="ica-row-label">Intereses de mora</div>
                            <div class="ica-row-value">
                                <input type="number" id="row_37" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field">
                            <div class="ica-row-number">38</div>
                            <div class="ica-row-label">
                                <strong>Total a pagar</strong>
                                <small>(Calculado: 35 ‚àí 36 + 37)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_38" class="form-control" readonly>
                            </div>
                        </div>
                        
                        <hr class="divider">
                        
                        <div class="section-title">Pago Voluntario</div>
                        <div class="row">
                            <div class="col-6">
                                <div class="ica-row">
                                    <div class="ica-row-number">39</div>
                                    <div class="ica-row-label">Pago voluntario (valor)</div>
                                    <div class="ica-row-value">
                                        <input type="number" id="row_39" class="form-control" min="0" step="0.01" value="0">
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-group">
                                    <label for="row_39_destination" class="form-label">Destino del aporte</label>
                                    <input type="text" id="row_39_destination" class="form-control" placeholder="Ej: Obras sociales, educaci√≥n...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="ica-row calculated-field" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid var(--primary-color);">
                            <div class="ica-row-number" style="background: rgba(59, 130, 246, 0.2); color: var(--primary-color);">40</div>
                            <div class="ica-row-label">
                                <strong>Total a pagar con pago voluntario</strong>
                                <small>(Calculado: 38 + 39)</small>
                            </div>
                            <div class="ica-row-value">
                                <input type="number" id="row_40" class="form-control" readonly
                                       style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color);">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones del Formulario -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-between align-center gap-2">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    üíæ Guardar Declaraci√≥n
                                </button>
                                <button type="button" class="btn btn-ghost btn-lg" id="btn-calculate">
                                    üîÑ Recalcular
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-info btn-lg" id="btn-preview-pdf">
                                    üëÅÔ∏è Vista Previa PDF
                                </button>
                                <button type="button" class="btn btn-success btn-lg" id="btn-open-signature">
                                    ‚úçÔ∏è Firmar Declaraci√≥n
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" id="btn-generate-pdf">
                                    üìÑ Descargar PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </main>
    
    <!-- Modal de Firma - SECCI√ìN F -->
    <div id="signature-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">‚úçÔ∏è SECCI√ìN F ‚Äì FIRMAS DIGITALES</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <strong>‚ö†Ô∏è Atenci√≥n:</strong> Una vez firmada la declaraci√≥n, queda bloqueada para edici√≥n.
                </div>
                
                <!-- Indicador para persona jur√≠dica -->
                <div id="juridica-signature-info" class="alert alert-info mb-3" style="display: none; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-left: 4px solid #2563eb;">
                    <strong>üè¢ Firma como Representante Legal:</strong> Los datos de firma corresponden al representante legal 
                    registrado de la empresa. Esta informaci√≥n es <strong>OBLIGATORIA</strong> y se usa para validar la declaraci√≥n.
                </div>
                
                <div class="section-title">FIRMA DEL DECLARANTE / REPRESENTANTE LEGAL</div>
                <div class="form-group">
                    <label for="declarant_name" class="form-label required">Nombre Completo</label>
                    <input type="text" id="declarant_name" class="form-control" required placeholder="Nombre completo"
                           style="background-color: #f0fdf4;">
                    <small class="form-text" style="color: #059669;">‚úì Campo obligatorio - autocompletado desde registro</small>
                </div>
                
                <div class="row">
                    <div class="col-6">
                        <div class="form-group">
                            <label for="declarant_document" class="form-label required">N√∫mero de Documento</label>
                            <input type="text" id="declarant_document" class="form-control" required placeholder="N√∫mero de documento"
                                   style="background-color: #f0fdf4;">
                            <small class="form-text" style="color: #059669;">‚úì Obligatorio</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label for="declaration_date" class="form-label required">Fecha de Declaraci√≥n</label>
                            <input type="date" id="declaration_date" class="form-control" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="signature_method" class="form-label">M√©todo de firma</label>
                    <select id="signature_method" class="form-control">
                        <option value="manuscrita">Firma manuscrita (canvas)</option>
                        <option value="clave">Firma con clave</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="declarant_oath" required>
                        Declaro bajo juramento que la informaci√≥n contenida en este formulario es ver√≠dica
                    </label>
                </div>
                
                <hr class="divider">
                
                <div class="section-title">FIRMA DEL CONTADOR / REVISOR FISCAL</div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="requires_fiscal_reviewer">
                        ¬øAplica revisor fiscal?
                    </label>
                </div>
                
                <div id="accountant-fields" style="display: none;">
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label for="accountant_name" class="form-label">Nombre</label>
                                <input type="text" id="accountant_name" class="form-control" placeholder="Nombre del contador o revisor fiscal">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label for="accountant_document" class="form-label">Documento</label>
                                <input type="text" id="accountant_document" class="form-control" placeholder="N√∫mero de documento">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="professional_card" class="form-label">Tarjeta profesional</label>
                        <input type="text" id="professional_card" class="form-control" placeholder="Ej: 12345-T">
                    </div>
                </div>
                
                <hr class="divider">
                
                <div class="form-group" id="signature-container">
                    <label class="form-label required">Firma Digital</label>
                    <p class="form-text">Dibuje su firma en el recuadro a continuaci√≥n:</p>
                    <div class="signature-container">
                        <canvas id="signature-canvas" class="signature-canvas"></canvas>
                    </div>
                    <div class="signature-actions">
                        <button type="button" class="btn btn-ghost" id="btn-clear-signature">
                            üóëÔ∏è Limpiar Firma
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost modal-close">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-confirm-signature">
                    ‚úÖ Confirmar y Firmar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Vista Previa PDF -->
    <div id="pdf-preview-modal" class="modal-overlay">
        <div class="modal" style="max-width: 900px; width: 95%; max-height: 95vh;">
            <div class="modal-header">
                <h2 class="modal-title">üëÅÔ∏è Vista Previa de la Declaraci√≥n</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0; height: 70vh;">
                <iframe id="pdf-preview-frame" style="width: 100%; height: 100%; border: none;"></iframe>
                <div id="pdf-preview-loading" class="text-center" style="padding: 3rem; display: none;">
                    <div class="spinner"></div>
                    <p style="margin-top: 1rem;">Generando vista previa...</p>
                </div>
                <div id="pdf-preview-error" class="alert alert-danger" style="margin: 1rem; display: none;"></div>
            </div>
            <div class="modal-footer">
                <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                    <div>
                        <span id="pdf-preview-status" class="badge" style="font-size: 0.875rem;"></span>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-ghost modal-close">Cerrar</button>
                        <button type="button" class="btn btn-primary" id="btn-download-from-preview">
                            üì• Descargar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema ICA - Formulario √önico Nacional de Declaraci√≥n y Pago</p>
            <p><small>Basado en: Documents/formulario-ICA.md</small></p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script src="../js/api.js"></script>
    <script src="../js/ica-form.js"></script>
    <script src="../js/signature.js"></script>
    <script>
        // Verificar autenticaci√≥n
        if (!AuthAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // Obtener ID de declaraci√≥n de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const declarationId = urlParams.get('id');
        const previewMode = urlParams.get('preview') === 'true';
        
        // Variable global para guardar el municipio del usuario
        let userMunicipalityId = null;
        let currentUserData = null;
        
        // Par√°metros de f√≥rmulas del municipio (cargados desde admin)
        let formulaParameters = {
            avisos_tableros_rate: 15,        // % sobre el ICA (Rengl√≥n 21)
            sobretasa_bomberil_rate: 0,      // % (Rengl√≥n 23)
            sobretasa_seguridad_rate: 0,     // % (Rengl√≥n 24)
            ley56_tarifa_kw: 0,              // Tarifa por kW (Rengl√≥n 19)
            unidades_financiero_rate: 0,     // (Rengl√≥n 22)
            anticipo_siguiente_rate: 40,     // % (Rengl√≥n 30)
            descuento_pronto_pago_rate: 10,  // % (Rengl√≥n 36)
            descuento_pronto_pago_dias: 30,  // D√≠as l√≠mite
            interes_mora_mensual_rate: 1     // % mensual (Rengl√≥n 37)
        };
        
        // Toggle campos de contador/revisor fiscal
        document.getElementById('requires_fiscal_reviewer').addEventListener('change', function() {
            document.getElementById('accountant-fields').style.display = this.checked ? 'block' : 'none';
        });
        
        // Cargar datos del usuario y obtener su municipio asignado
        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                currentUserData = user;
                document.getElementById('user-name').textContent = user.full_name;
                
                // Guardar el municipio del usuario para auto-selecci√≥n
                if (user.municipality_id) {
                    userMunicipalityId = user.municipality_id;
                }
                
                // Autocompletar datos seg√∫n tipo de persona
                autoFillTaxpayerData(user);
                autoFillSignatureData(user);
                
                return user;
            } catch (error) {
                console.error('Error loading user:', error);
                return null;
            }
        }
        
        // Autocompletar SECCI√ìN A (Contribuyente) seg√∫n tipo de persona
        function autoFillTaxpayerData(user) {
            if (!user) return;
            
            const isJuridica = user.person_type === 'juridica';
            
            // IDs de campos que ser√°n autocompletados y deshabilitados
            const taxpayerFields = [
                'legal_name', 'document_type', 'document_number', 'verification_digit',
                'address', 'phone', 'email', 'taxpayer_department', 'taxpayer_municipality'
            ];
            
            if (isJuridica) {
                // PERSONA JUR√çDICA: Usar datos de la empresa
                document.getElementById('legal_name').value = user.company_name || '';
                document.getElementById('document_type').value = 'NIT';
                document.getElementById('document_number').value = user.nit || '';
                document.getElementById('verification_digit').value = user.nit_verification_digit || '';
                document.getElementById('address').value = user.company_address || '';
                document.getElementById('phone').value = user.company_phone || '';
                document.getElementById('email').value = user.company_email || user.email || '';
                
                // Marcar como privada por defecto
                document.getElementById('entity_type').value = 'privada';
                
                // Mostrar indicador de persona jur√≠dica
                showPersonTypeIndicator('juridica', user.company_name);
            } else {
                // PERSONA NATURAL: Usar datos personales
                document.getElementById('legal_name').value = user.full_name || '';
                document.getElementById('document_type').value = user.document_type || 'CC';
                document.getElementById('document_number').value = user.document_number || '';
                document.getElementById('address').value = user.address || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('email').value = user.email || '';
                
                // Mostrar indicador de persona natural
                showPersonTypeIndicator('natural', user.full_name);
            }
            
            // Autocompletar departamento y municipio si tiene municipio asignado
            if (user.municipality) {
                document.getElementById('taxpayer_department').value = user.municipality.department || '';
                document.getElementById('taxpayer_municipality').value = user.municipality.name || '';
            }
            
            // DESHABILITAR campos autocompletados (obligatorios pero no editables)
            taxpayerFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    field.readOnly = true;
                    field.style.backgroundColor = '#e5e7eb';
                    field.style.cursor = 'not-allowed';
                    field.title = 'Campo autocompletado desde su registro - no editable';
                }
            });
        }
        
        // Autocompletar SECCI√ìN F (Firma) seg√∫n tipo de persona
        function autoFillSignatureData(user) {
            if (!user) return;
            
            const isJuridica = user.person_type === 'juridica';
            
            if (isJuridica) {
                // PERSONA JUR√çDICA: El representante legal firma (es el usuario logueado)
                document.getElementById('declarant_name').value = user.full_name || '';
                document.getElementById('declarant_document').value = user.document_number || '';
            } else {
                // PERSONA NATURAL: El usuario mismo firma
                document.getElementById('declarant_name').value = user.full_name || '';
                document.getElementById('declarant_document').value = user.document_number || '';
            }
            
            // Deshabilitar campos de firma (autocompletados)
            const signatureFields = ['declarant_name', 'declarant_document'];
            signatureFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    field.readOnly = true;
                    field.style.backgroundColor = '#e5e7eb';
                    field.style.cursor = 'not-allowed';
                    field.title = 'Campo autocompletado desde su registro - no editable';
                }
            });
            
            // Mostrar indicador para persona jur√≠dica en el modal de firma
            const juridicaInfo = document.getElementById('juridica-signature-info');
            if (juridicaInfo) {
                juridicaInfo.style.display = user.person_type === 'juridica' ? 'block' : 'none';
            }
        }
        
        // Mostrar indicador visual del tipo de persona
        function showPersonTypeIndicator(type, name) {
            const alertContainer = document.getElementById('alert-container');
            
            // Remover indicador previo si existe
            const existingIndicator = document.getElementById('person-type-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const isJuridica = type === 'juridica';
            const indicator = document.createElement('div');
            indicator.id = 'person-type-indicator';
            indicator.className = 'alert';
            indicator.style.cssText = isJuridica 
                ? 'background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #2563eb; margin-bottom: 1rem;'
                : 'background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid #10b981; margin-bottom: 1rem;';
            
            indicator.innerHTML = isJuridica
                ? `<strong>üè¢ Declaraci√≥n como PERSONA JUR√çDICA</strong><br>
                   <span style="font-size: 0.875rem;">Empresa: ${name || 'N/A'}<br>
                   Los datos del contribuyente se han autocompletado con la informaci√≥n de la empresa.<br>
                   La firma corresponde al representante legal registrado.</span>`
                : `<strong>üë§ Declaraci√≥n como PERSONA NATURAL</strong><br>
                   <span style="font-size: 0.875rem;">Contribuyente: ${name || 'N/A'}<br>
                   Los datos se han autocompletado con su informaci√≥n de registro.</span>`;
            
            alertContainer.insertBefore(indicator, alertContainer.firstChild);
        }
        
        // Cargar par√°metros de f√≥rmulas del municipio
        async function loadFormulaParameters(municipalityId) {
            try {
                const params = await AdminAPI.getFormulaParameters(municipalityId);
                if (params) {
                    // Mapear nombres del backend a nombres locales
                    formulaParameters = {
                        avisos_tableros_rate: params.avisos_tableros_porcentaje || 15,
                        sobretasa_bomberil_rate: params.sobretasa_bomberil_porcentaje || 0,
                        sobretasa_seguridad_rate: params.sobretasa_seguridad_porcentaje || 0,
                        ley56_tarifa_kw: params.ley_56_tarifa_por_kw || 0,
                        unidades_financiero_rate: params.unidades_adicionales_financiero_valor || 0,
                        anticipo_siguiente_rate: params.anticipo_ano_siguiente_porcentaje || 40,
                        descuento_pronto_pago_rate: params.descuento_pronto_pago_porcentaje || 10,
                        descuento_pronto_pago_dias: params.descuento_pronto_pago_dias || 30,
                        interes_mora_mensual_rate: params.interes_mora_mensual || 1
                    };
                    
                    // Actualizar displays
                    const avisosRateDisplay = document.getElementById('avisos_rate_display');
                    if (avisosRateDisplay) {
                        avisosRateDisplay.textContent = formulaParameters.avisos_tableros_rate;
                    }
                    
                    console.log('Par√°metros de f√≥rmulas cargados:', formulaParameters);
                }
            } catch (error) {
                console.log('No se pudieron cargar par√°metros de f√≥rmulas:', error.message);
            }
        }
        
        // Manejar checkbox de avisos y tableros
        function setupAvisosTablerosCheckbox() {
            const checkbox = document.getElementById('uses_signs_boards');
            const formulaDisplay = document.getElementById('row_21_formula');
            const row21Input = document.getElementById('row_21');
            
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        formulaDisplay.style.display = 'block';
                        recalculateFromParameters();
                    } else {
                        formulaDisplay.style.display = 'none';
                        row21Input.value = '0';
                        if (formController) formController.recalculate();
                    }
                });
            }
        }
        
        // NOTA: La funci√≥n recalculateFromParameters fue reemplazada por applyFormulaParameters
        // que se llama desde initializeForm para evitar bucles infinitos
        
        // Verificaci√≥n Secci√≥n C: Rengl√≥n 15 = Suma ingresos gravados actividades
        function verifySectionC() {
            const row15 = parseFloat(document.getElementById('row_15')?.value) || 0;
            const totalActivitiesIncomeText = document.getElementById('total-taxed-income')?.textContent || '$0.00';
            const totalActivitiesIncome = parseFloat(totalActivitiesIncomeText.replace(/[$,]/g, '')) || 0;
            
            const verificationDiv = document.getElementById('section-c-verification');
            const contentDiv = document.getElementById('verification-content');
            
            if (!verificationDiv || !contentDiv) return;
            
            const difference = Math.abs(row15 - totalActivitiesIncome);
            const isValid = difference < 0.01; // Tolerancia para redondeo
            
            verificationDiv.style.display = 'block';
            
            if (isValid) {
                verificationDiv.className = 'alert';
                verificationDiv.style.cssText = 'margin-top: 1rem; background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-left: 4px solid #10b981;';
                contentDiv.innerHTML = `
                    <strong>‚úÖ Verificaci√≥n Correcta</strong><br>
                    <span style="font-size: 0.875rem;">
                        Rengl√≥n 15 (Total ingresos gravables): <strong>$${row15.toLocaleString('es-CO', {minimumFractionDigits: 2})}</strong><br>
                        Suma Secci√≥n C (Ingresos gravados): <strong>$${totalActivitiesIncome.toLocaleString('es-CO', {minimumFractionDigits: 2})}</strong>
                    </span>
                `;
            } else {
                verificationDiv.className = 'alert';
                verificationDiv.style.cssText = 'margin-top: 1rem; background: linear-gradient(135deg, #fee2e2, #fecaca); border-left: 4px solid #ef4444;';
                contentDiv.innerHTML = `
                    <strong>‚ö†Ô∏è Verificaci√≥n: Diferencia Detectada</strong><br>
                    <span style="font-size: 0.875rem;">
                        Rengl√≥n 15 (Total ingresos gravables): <strong>$${row15.toLocaleString('es-CO', {minimumFractionDigits: 2})}</strong><br>
                        Suma Secci√≥n C (Ingresos gravados): <strong>$${totalActivitiesIncome.toLocaleString('es-CO', {minimumFractionDigits: 2})}</strong><br>
                        <span style="color: #ef4444;">Diferencia: $${difference.toLocaleString('es-CO', {minimumFractionDigits: 2})}</span><br>
                        <em>El total de ingresos gravables (R15) debe coincidir con la suma de ingresos gravados en las actividades de la Secci√≥n C.</em>
                    </span>
                `;
            }
        }
        
        // Vista previa del PDF
        async function showPdfPreview() {
            if (!formController || !formController.declarationId) {
                showAlert('‚ö†Ô∏è Primero debe guardar la declaraci√≥n antes de ver la vista previa', 'warning');
                return;
            }
            
            const modal = document.getElementById('pdf-preview-modal');
            const frame = document.getElementById('pdf-preview-frame');
            const loadingDiv = document.getElementById('pdf-preview-loading');
            const errorDiv = document.getElementById('pdf-preview-error');
            const statusSpan = document.getElementById('pdf-preview-status');
            
            // Mostrar modal
            modal.classList.add('active');
            frame.style.display = 'none';
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            
            try {
                // Generar PDF primero (si no existe)
                await DeclarationsAPI.generatePDF(formController.declarationId);
                
                // Obtener URL del PDF para vista previa
                const token = localStorage.getItem('accessToken');
                const pdfUrl = `/api/v1/declarations/${formController.declarationId}/download-pdf`;
                
                // Cargar en iframe usando blob
                const response = await fetch(pdfUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error('No se pudo obtener el PDF');
                }
                
                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                
                frame.src = objectUrl;
                frame.style.display = 'block';
                loadingDiv.style.display = 'none';
                
                // Obtener estado de firma
                const declaration = await DeclarationsAPI.get(formController.declarationId);
                if (declaration.is_signed) {
                    statusSpan.textContent = '‚úÖ Declaraci√≥n Firmada';
                    statusSpan.style.cssText = 'background: #10b981; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem;';
                } else {
                    statusSpan.textContent = 'üìù Borrador (Sin Firmar)';
                    statusSpan.style.cssText = 'background: #f59e0b; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem;';
                }
                
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = '‚ùå Error al generar vista previa: ' + error.message;
            }
        }
        
        // Cerrar modal de vista previa PDF
        function setupPdfPreviewModal() {
            const modal = document.getElementById('pdf-preview-modal');
            const closeButtons = modal.querySelectorAll('.modal-close');
            
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.classList.remove('active');
                    const frame = document.getElementById('pdf-preview-frame');
                    if (frame.src) {
                        URL.revokeObjectURL(frame.src);
                        frame.src = '';
                    }
                });
            });
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
            
            // Bot√≥n descargar desde preview
            document.getElementById('btn-download-from-preview')?.addEventListener('click', async () => {
                if (formController && formController.declarationId) {
                    try {
                        await DeclarationsAPI.downloadPDF(formController.declarationId);
                    } catch (error) {
                        showAlert('‚ùå Error al descargar PDF: ' + error.message, 'danger');
                    }
                }
            });
        }
        
        // Cargar municipios y auto-seleccionar el municipio del usuario
        async function loadMunicipalities() {
            try {
                const municipalities = await AdminAPI.listMunicipalities();
                const select = document.getElementById('municipality_id');
                
                municipalities.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.textContent = `${m.name} - ${m.department}`;
                    select.appendChild(option);
                });
                
                // Auto-seleccionar el municipio del usuario si est√° asignado
                if (userMunicipalityId) {
                    // Convertir a string para comparaci√≥n consistente con el valor del option
                    select.value = String(userMunicipalityId);
                    
                    // Tambi√©n auto-seleccionar el departamento correspondiente
                    // Usar comparaci√≥n de tipo consistente (convertir ambos a n√∫mero)
                    const selectedMunicipality = municipalities.find(m => Number(m.id) === Number(userMunicipalityId));
                    if (selectedMunicipality) {
                        const deptSelect = document.getElementById('department');
                        deptSelect.value = selectedMunicipality.department;
                        
                        // Disparar el evento change para actualizar la secci√≥n de Bogot√° si aplica
                        deptSelect.dispatchEvent(new Event('change'));
                    }
                    
                    // Cargar par√°metros de f√≥rmulas del municipio
                    await loadFormulaParameters(userMunicipalityId);
                }
                
                // Escuchar cambios de municipio para recargar par√°metros
                select.addEventListener('change', async function() {
                    if (this.value) {
                        await loadFormulaParameters(this.value);
                    }
                });
            } catch (error) {
                console.error('Error loading municipalities:', error);
            }
        }
        
        // Mostrar/ocultar secci√≥n de Bogot√° seg√∫n departamento
        const BOGOTA_DEPARTMENT = 'Bogot√° D.C.';
        document.getElementById('department').addEventListener('change', function() {
            const bogotaSection = document.getElementById('bogota-section');
            if (this.value === BOGOTA_DEPARTMENT) {
                bogotaSection.style.display = 'block';
            } else {
                bogotaSection.style.display = 'none';
            }
        });
        
        // Mostrar/ocultar campos de correcci√≥n seg√∫n tipo de declaraci√≥n
        document.getElementById('declaration_type').addEventListener('change', function() {
            const correctionFields = document.getElementById('correction-fields');
            const correctionDateField = document.getElementById('correction-date-field');
            if (this.value === 'correccion') {
                correctionFields.style.display = 'block';
                correctionDateField.style.display = 'block';
            } else {
                correctionFields.style.display = 'none';
                correctionDateField.style.display = 'none';
            }
        });
        
        // Habilitar modo vista previa
        function enablePreviewMode() {
            // Mostrar banner de vista previa
            const alertContainer = document.getElementById('alert-container');
            const previewBanner = document.createElement('div');
            previewBanner.className = 'alert alert-info';
            previewBanner.setAttribute('role', 'alert');
            previewBanner.setAttribute('aria-live', 'polite');
            previewBanner.style.cssText = 'background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border-left: 4px solid #0284c7;';
            previewBanner.innerHTML = `
                <strong>üëÅÔ∏è MODO VISTA PREVIA</strong> - Este es un formulario de ejemplo para verificar la estructura de campos.
                <button type="button" class="btn btn-primary" style="margin-left: 1rem;" id="btn-create-declaration">
                    ‚úèÔ∏è Crear Nueva Declaraci√≥n
                </button>
            `;
            alertContainer.appendChild(previewBanner);
            
            // Agregar event listener al bot√≥n
            document.getElementById('btn-create-declaration').addEventListener('click', function() {
                window.location.href = 'form.html';
            });
            
            // Constante para el texto ARIA de vista previa
            const PREVIEW_ARIA_SUFFIX = ' (modo vista previa - solo lectura)';
            
            // Usar readonly en lugar de disabled para mejor accesibilidad
            // y agregar atributos ARIA para explicar el modo vista previa
            const formInputs = document.querySelectorAll('#ica-form input, #ica-form select, #ica-form textarea');
            formInputs.forEach(input => {
                const currentLabel = input.getAttribute('aria-label') || input.name || '';
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.disabled = true;
                    input.setAttribute('aria-label', currentLabel + PREVIEW_ARIA_SUFFIX);
                } else if (input.tagName === 'SELECT') {
                    input.disabled = true;
                    input.setAttribute('aria-label', currentLabel + PREVIEW_ARIA_SUFFIX);
                } else {
                    input.readOnly = true;
                    input.setAttribute('aria-readonly', 'true');
                }
                input.setAttribute('tabindex', '0');
            });
            
            // Agregar mensaje para lectores de pantalla
            const srAnnouncement = document.createElement('div');
            srAnnouncement.className = 'sr-only';
            srAnnouncement.setAttribute('role', 'status');
            srAnnouncement.setAttribute('aria-live', 'polite');
            srAnnouncement.textContent = 'Modo vista previa activado. El formulario est√° en modo de solo lectura con datos de ejemplo.';
            alertContainer.appendChild(srAnnouncement);
            
            // Ocultar botones de acci√≥n
            const actionButtons = document.querySelectorAll('#ica-form button[type="submit"], #btn-open-signature, #btn-generate-pdf');
            actionButtons.forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Ocultar bot√≥n recalcular
            const calcBtn = document.getElementById('btn-calculate');
            if (calcBtn) {
                calcBtn.style.display = 'none';
            }
            
            // Agregar valores de ejemplo para vista previa
            fillPreviewData();
        }
        
        // Helper function to safely set element value
        function setElementValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
            }
        }
        
        // Llenar datos de ejemplo para vista previa
        function fillPreviewData() {
            // Datos de ejemplo para vista previa (con verificaci√≥n de existencia)
            setElementValue('legal_name', 'Empresa Ejemplo S.A.S.');
            setElementValue('document_type', 'NIT');
            setElementValue('document_number', '900123456');
            setElementValue('verification_digit', '7');
            setElementValue('address', 'Calle 123 # 45-67, Centro');
            setElementValue('phone', '3001234567');
            setElementValue('email', 'ejemplo@empresa.com');
            setElementValue('num_establishments', '1');
            
            // Valores num√©ricos de ejemplo
            setElementValue('row_8', '100000000');
            setElementValue('row_9', '10000000');
            setElementValue('row_11', '5000000');
            setElementValue('row_12', '2000000');
            setElementValue('row_13', '1000000');
            setElementValue('row_14', '500000');
        }
        
        // Inicializar formulario
        function initializeForm() {
            // Establecer a√±o actual por defecto
            document.getElementById('tax_year').value = new Date().getFullYear();
            
            // Establecer fecha actual para firma
            document.getElementById('declaration_date').value = 
                new Date().toISOString().split('T')[0];
            
            // Inicializar controlador de formulario
            const form = document.getElementById('ica-form');
            formController = new ICAFormController(form, declarationId ? parseInt(declarationId) : null);
            
            // Inicializar modal de firma
            const signatureModal = new SignatureModal('signature-modal', 'signature-canvas', {
                declarationId: declarationId ? parseInt(declarationId) : null,
                onSign: (data) => {
                    console.log('Declaraci√≥n firmada:', data);
                }
            });
            
            // Configurar checkbox de avisos y tableros
            setupAvisosTablerosCheckbox();
            
            // Configurar modal de vista previa PDF
            setupPdfPreviewModal();
            
            // Extender recalculate para aplicar par√°metros de f√≥rmulas y verificaci√≥n
            const originalRecalculate = formController.recalculate.bind(formController);
            formController.recalculate = function() {
                // 1. Ejecutar c√°lculo base
                originalRecalculate();
                
                // 2. Aplicar par√°metros de f√≥rmulas (sin llamar a recalculate de nuevo)
                applyFormulaParameters();
                
                // 3. Verificar Secci√≥n C
                verifySectionC();
            };
            
            // Activar modo vista previa si se solicita
            if (previewMode) {
                enablePreviewMode();
            }
        }
        
        // Aplicar par√°metros de f√≥rmulas sin recursi√≥n
        function applyFormulaParameters() {
            if (!formController) return;
            
            const row20 = parseFloat(document.getElementById('row_20')?.value) || 0;
            
            // Rengl√≥n 21: Avisos y Tableros (solo si est√° marcado el checkbox)
            const usesSignsBoards = document.getElementById('uses_signs_boards')?.checked || false;
            if (usesSignsBoards) {
                const row21 = row20 * (formulaParameters.avisos_tableros_rate / 100);
                document.getElementById('row_21').value = row21.toFixed(2);
            }
            
            // Rengl√≥n 23: Sobretasa bomberil
            if (formulaParameters.sobretasa_bomberil_rate > 0) {
                const row23 = row20 * (formulaParameters.sobretasa_bomberil_rate / 100);
                document.getElementById('row_23').value = row23.toFixed(2);
            }
            
            // Rengl√≥n 24: Sobretasa seguridad
            if (formulaParameters.sobretasa_seguridad_rate > 0) {
                const row24 = row20 * (formulaParameters.sobretasa_seguridad_rate / 100);
                document.getElementById('row_24').value = row24.toFixed(2);
            }
        }
        
        // Bot√≥n recalcular
        document.getElementById('btn-calculate').addEventListener('click', () => {
            if (formController) {
                formController.recalculate();
                showAlert('‚úÖ Valores recalculados correctamente', 'success');
            }
        });
        
        // Bot√≥n vista previa PDF
        document.getElementById('btn-preview-pdf').addEventListener('click', async () => {
            await showPdfPreview();
        });
        
        // Bot√≥n descargar PDF
        document.getElementById('btn-generate-pdf').addEventListener('click', async () => {
            if (!formController || !formController.declarationId) {
                showAlert('‚ö†Ô∏è Primero debe guardar la declaraci√≥n', 'warning');
                return;
            }
            
            try {
                showLoading();
                await DeclarationsAPI.generatePDF(formController.declarationId);
                await DeclarationsAPI.downloadPDF(formController.declarationId);
                hideLoading();
                showAlert('üìÑ PDF descargado correctamente.', 'success');
            } catch (error) {
                hideLoading();
                showAlert('‚ùå Error al descargar PDF: ' + error.message, 'danger');
            }
        });
        
        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await AuthAPI.logout();
            window.location.href = 'login.html';
        });
        
        // Inicializar - primero cargar usuario, luego municipios
        async function init() {
            await loadUserData();
            await loadMunicipalities();
            initializeForm();
        }
        
        init();
    </script>
</body>
</html>
