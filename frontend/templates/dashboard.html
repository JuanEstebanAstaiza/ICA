<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Declaraci√≥n ICA - Panel de Control">
    <title>Panel de Control - Sistema ICA</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            border-radius: var(--radius);
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination-info {
            margin: 0 1rem;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <span class="logo-text">üèõÔ∏è Sistema ICA</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html" class="active">Inicio</a></li>
                    <li><a href="form.html">Nueva Declaraci√≥n</a></li>
                    <li><a href="admin.html" id="admin-link" style="display: none;">Administraci√≥n</a></li>
                    <li><a href="superadmin.html" id="superadmin-link" style="display: none;">Super Admin</a></li>
                </ul>
            </nav>
            
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-outline" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div id="alert-container"></div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <h1 style="font-size: 1.75rem; font-weight: 700; color: var(--text-color);">Panel de Control</h1>
                    <p class="text-muted">Bienvenido al Sistema de Declaraci√≥n ICA - Formulario √önico Nacional</p>
                    <div id="colombia-time-display" style="font-size: 0.9rem; color: var(--primary-color); margin-top: 0.5rem;">
                        üïê Hora Colombia: <span id="colombia-time">Cargando...</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="row mb-3">
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color);" id="stat-total">0</div>
                            <p class="text-muted mb-0">Total Declaraciones</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning-color);" id="stat-draft">0</div>
                            <p class="text-muted mb-0">En Borrador</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--success-color);" id="stat-signed">0</div>
                            <p class="text-muted mb-0">Firmadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card" style="background: var(--accent-gradient);">
                        <div class="card-body text-center">
                            <a href="form.html" class="btn btn-lg" style="background: white; color: var(--accent-color); font-weight: 600;">
                                ‚ûï Nueva Declaraci√≥n
                            </a>
                            <a href="form.html?preview=true" class="btn btn-sm" style="background: rgba(255,255,255,0.8); color: var(--primary-color); margin-top: 0.5rem; display: block;">
                                üëÅÔ∏è Vista Previa del Formulario
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Declarations -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            üìã Mis Declaraciones
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="declarations-table">
                                    <thead>
                                        <tr>
                                            <th>No. Formulario</th>
                                            <th>No. Radicado</th>
                                            <th>A√±o</th>
                                            <th>Tipo</th>
                                            <th>Estado</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="declarations-body">
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="spinner" style="margin: 1rem auto;"></div>
                                                <p class="text-muted">Cargando declaraciones...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="user-declarations-pagination" class="pagination" style="margin-top: 1rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema ICA - Formulario √önico Nacional de Declaraci√≥n y Pago</p>
            <p><small>Basado en: Documents/formulario-ICA.md</small></p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script src="../js/api.js"></script>
    <script>
        // Verificar autenticaci√≥n
        if (!AuthAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // Cargar datos del usuario
        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                document.getElementById('user-name').textContent = user.full_name;
                
                // Mostrar link de admin si tiene permisos
                if (user.role === 'admin_alcaldia' || user.role === 'admin_sistema') {
                    document.getElementById('admin-link').style.display = 'inline';
                }
                
                // Mostrar link de super admin solo para admin_sistema
                if (user.role === 'admin_sistema') {
                    document.getElementById('superadmin-link').style.display = 'inline';
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        
        // Paginaci√≥n de declaraciones
        let userDeclarations = [];
        let userCurrentPage = 1;
        const USER_DECLARATIONS_PER_PAGE = 10;
        
        // Cargar declaraciones
        async function loadDeclarations() {
            try {
                userDeclarations = await DeclarationsAPI.list();
                
                // Actualizar estad√≠sticas
                document.getElementById('stat-total').textContent = userDeclarations.length;
                document.getElementById('stat-draft').textContent = 
                    userDeclarations.filter(d => d.status === 'borrador').length;
                document.getElementById('stat-signed').textContent = 
                    userDeclarations.filter(d => d.status === 'firmado').length;
                
                userCurrentPage = 1;
                renderDeclarationsPage();
                
            } catch (error) {
                console.error('Error loading declarations:', error);
                document.getElementById('declarations-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="color: var(--danger-color);">
                            ‚ùå Error al cargar declaraciones
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderDeclarationsPage() {
            const tbody = document.getElementById('declarations-body');
            
            if (userDeclarations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center empty-state">
                            <div class="empty-state-icon">üìÑ</div>
                            <p>No tiene declaraciones a√∫n.</p>
                            <a href="form.html" class="btn btn-primary">‚ûï Crear nueva declaraci√≥n</a>
                        </td>
                    </tr>
                `;
                renderUserPagination(0);
                return;
            }
            
            // Calcular paginaci√≥n
            const totalPages = Math.ceil(userDeclarations.length / USER_DECLARATIONS_PER_PAGE);
            const startIndex = (userCurrentPage - 1) * USER_DECLARATIONS_PER_PAGE;
            const endIndex = startIndex + USER_DECLARATIONS_PER_PAGE;
            const pageDeclarations = userDeclarations.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageDeclarations.map(d => `
                <tr>
                    <td><strong>${d.form_number || 'Sin n√∫mero'}</strong></td>
                    <td style="font-family: 'Roboto Mono', monospace; font-size: 0.85rem;">
                        ${d.filing_number || '<span style="color: #9ca3af;">Pendiente</span>'}
                    </td>
                    <td>${d.tax_year}</td>
                    <td>${formatDeclarationType(d.declaration_type)}</td>
                    <td>
                        <span class="badge badge-${d.status}">
                            ${d.status.toUpperCase()}
                        </span>
                        ${d.has_been_corrected ? '<span class="badge" style="background: #f59e0b; margin-left: 4px;">Corregida</span>' : ''}
                        ${d.correction_of_id ? '<span class="badge" style="background: #8b5cf6; margin-left: 4px;">Es correcci√≥n</span>' : ''}
                    </td>
                    <td>${new Date(d.created_at).toLocaleDateString('es-CO')}</td>
                    <td>
                        <div class="d-flex gap-1" style="flex-wrap: wrap;">
                            <a href="form.html?id=${d.id}" class="btn btn-sm btn-primary">
                                ${d.is_signed ? 'üëÅÔ∏è Ver' : '‚úèÔ∏è Editar'}
                            </a>
                            ${d.is_signed ? `
                                <button class="btn btn-sm btn-secondary" onclick="downloadPDF(${d.id})">
                                    üìÑ PDF
                                </button>
                            ` : ''}
                            ${d.is_signed && !d.has_been_corrected && !d.correction_of_id ? `
                                <button class="btn btn-sm" style="background: #f59e0b; color: white;" 
                                        onclick="createCorrection(${d.id})" 
                                        title="Crear correcci√≥n de esta declaraci√≥n (solo 1 permitida)">
                                    üîÑ Corregir
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
            
            renderUserPagination(totalPages);
        }
        
        function renderUserPagination(totalPages) {
            const paginationContainer = document.getElementById('user-declarations-pagination');
            
            if (!paginationContainer) return;
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let html = `
                <button onclick="goToUserPage(1)" ${userCurrentPage === 1 ? 'disabled' : ''}>¬´</button>
                <button onclick="goToUserPage(${userCurrentPage - 1})" ${userCurrentPage === 1 ? 'disabled' : ''}>‚Äπ</button>
            `;
            
            // Mostrar n√∫meros de p√°gina
            const startPage = Math.max(1, userCurrentPage - 2);
            const endPage = Math.min(totalPages, userCurrentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="goToUserPage(${i})" class="${i === userCurrentPage ? 'active' : ''}">${i}</button>`;
            }
            
            html += `
                <button onclick="goToUserPage(${userCurrentPage + 1})" ${userCurrentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>
                <button onclick="goToUserPage(${totalPages})" ${userCurrentPage === totalPages ? 'disabled' : ''}>¬ª</button>
                <span class="pagination-info">P√°gina ${userCurrentPage} de ${totalPages} (${userDeclarations.length} declaraciones)</span>
            `;
            
            paginationContainer.innerHTML = html;
        }
        
        function goToUserPage(page) {
            const totalPages = Math.ceil(userDeclarations.length / USER_DECLARATIONS_PER_PAGE);
            if (page < 1 || page > totalPages) return;
            userCurrentPage = page;
            renderDeclarationsPage();
        }
        
        function formatDeclarationType(type) {
            const types = {
                'inicial': 'Inicial',
                'correccion': 'Correcci√≥n'
            };
            return types[type] || type;
        }
        
        async function downloadPDF(declarationId) {
            try {
                showLoading();
                await DeclarationsAPI.downloadPDF(declarationId);
                hideLoading();
            } catch (error) {
                hideLoading();
                alert('Error al descargar PDF: ' + error.message);
            }
        }
        
        async function createCorrection(declarationId) {
            // Confirmar antes de crear la correcci√≥n
            const confirmed = confirm(
                '‚ö†Ô∏è CREAR CORRECCI√ìN DE DECLARACI√ìN\n\n' +
                '‚Ä¢ Se crear√° una copia de la declaraci√≥n original\n' +
                '‚Ä¢ Podr√° editar los valores que necesite corregir\n' +
                '‚Ä¢ Al firmar, se generar√° un NUEVO n√∫mero de radicado\n' +
                '‚Ä¢ Solo puede realizar 1 correcci√≥n por declaraci√≥n original\n\n' +
                '¬øDesea continuar?'
            );
            
            if (!confirmed) return;
            
            try {
                showLoading();
                const correction = await DeclarationsAPI.createCorrection(declarationId);
                hideLoading();
                
                // Mostrar popup de √©xito
                alert(
                    '‚úÖ CORRECCI√ìN CREADA EXITOSAMENTE\n\n' +
                    'N√∫mero de formulario: ' + correction.form_number + '\n\n' +
                    'Ser√° redirigido al formulario para realizar las correcciones necesarias.'
                );
                
                // Redirigir al formulario de correcci√≥n
                window.location.href = `form.html?id=${correction.id}`;
                
            } catch (error) {
                hideLoading();
                alert('‚ùå Error al crear correcci√≥n: ' + error.message);
            }
        }
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        
        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await AuthAPI.logout();
            window.location.href = 'login.html';
        });
        
        // Funci√≥n para cargar y mostrar hora de Colombia
        async function loadColombiaTime() {
            try {
                const timeData = await AuthAPI.getColombiaTime();
                document.getElementById('colombia-time').textContent = timeData.formatted;
            } catch (error) {
                // Si falla el endpoint, calcular hora de Colombia localmente (UTC-5)
                const now = new Date();
                const colombiaOffset = -5 * 60; // UTC-5 en minutos
                const localOffset = now.getTimezoneOffset();
                const colombiaTime = new Date(now.getTime() + (localOffset + colombiaOffset) * 60000);
                document.getElementById('colombia-time').textContent = colombiaTime.toLocaleString('es-CO');
            }
        }
        
        // Actualizar hora de Colombia cada minuto
        function startColombiaTimeClock() {
            loadColombiaTime();
            setInterval(loadColombiaTime, 60000); // Actualizar cada minuto
        }
        
        // Inicializar
        loadUserData();
        loadDeclarations();
        startColombiaTimeClock();
    </script>
</body>
</html>
