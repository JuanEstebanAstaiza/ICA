<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Declaraci√≥n ICA - Panel de Control">
    <title>Panel de Control - Sistema ICA</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <div class="logo">
                <span class="logo-text">üèõÔ∏è Sistema ICA</span>
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li><a href="dashboard.html" class="active">Inicio</a></li>
                    <li><a href="form.html">Nueva Declaraci√≥n</a></li>
                    <li><a href="admin.html" id="admin-link" style="display: none;">Administraci√≥n</a></li>
                </ul>
            </nav>
            
            <div class="user-info">
                <span id="user-name"></span>
                <button class="btn btn-outline" id="btn-logout">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        <div class="container">
            <div id="alert-container"></div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <h1 style="font-size: 1.75rem; font-weight: 700; color: var(--text-color);">Panel de Control</h1>
                    <p class="text-muted">Bienvenido al Sistema de Declaraci√≥n ICA - Formulario √önico Nacional</p>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="row mb-3">
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color);" id="stat-total">0</div>
                            <p class="text-muted mb-0">Total Declaraciones</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning-color);" id="stat-draft">0</div>
                            <p class="text-muted mb-0">En Borrador</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div style="font-size: 2.5rem; font-weight: 700; color: var(--success-color);" id="stat-signed">0</div>
                            <p class="text-muted mb-0">Firmadas</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card" style="background: var(--accent-gradient);">
                        <div class="card-body text-center">
                            <a href="form.html" class="btn btn-lg" style="background: white; color: var(--accent-color); font-weight: 600;">
                                ‚ûï Nueva Declaraci√≥n
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Declarations -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            üìã Mis Declaraciones
                        </div>
                        <div class="card-body">
                            <table class="table" id="declarations-table">
                                <thead>
                                    <tr>
                                        <th>No. Formulario</th>
                                        <th>A√±o Gravable</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Fecha Creaci√≥n</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="declarations-body">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner" style="margin: 1rem auto;"></div>
                                            <p class="text-muted">Cargando declaraciones...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema ICA - Formulario √önico Nacional de Declaraci√≥n y Pago</p>
            <p><small>Basado en: Documents/formulario-ICA.md</small></p>
        </div>
    </footer>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <script src="../js/api.js"></script>
    <script>
        // Verificar autenticaci√≥n
        if (!AuthAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }
        
        // Cargar datos del usuario
        async function loadUserData() {
            try {
                const user = await AuthAPI.getCurrentUser();
                document.getElementById('user-name').textContent = user.full_name;
                
                // Mostrar link de admin si tiene permisos
                if (user.role === 'admin_alcaldia' || user.role === 'admin_sistema') {
                    document.getElementById('admin-link').style.display = 'inline';
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }
        
        // Cargar declaraciones
        async function loadDeclarations() {
            try {
                const declarations = await DeclarationsAPI.list();
                
                // Actualizar estad√≠sticas
                document.getElementById('stat-total').textContent = declarations.length;
                document.getElementById('stat-draft').textContent = 
                    declarations.filter(d => d.status === 'borrador').length;
                document.getElementById('stat-signed').textContent = 
                    declarations.filter(d => d.status === 'firmado').length;
                
                // Renderizar tabla
                const tbody = document.getElementById('declarations-body');
                
                if (declarations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center" style="padding: 3rem;">
                                <div style="color: var(--text-muted);">
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                                    <p>No tiene declaraciones a√∫n.</p>
                                    <a href="form.html" class="btn btn-primary">‚ûï Crear nueva declaraci√≥n</a>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = declarations.map(d => `
                    <tr>
                        <td><strong>${d.form_number || 'Sin n√∫mero'}</strong></td>
                        <td>${d.tax_year}</td>
                        <td>${formatDeclarationType(d.declaration_type)}</td>
                        <td>
                            <span class="badge badge-${d.status}">
                                ${d.status.toUpperCase()}
                            </span>
                        </td>
                        <td>${new Date(d.created_at).toLocaleDateString('es-CO')}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="form.html?id=${d.id}" class="btn btn-sm btn-primary">
                                    ${d.is_signed ? 'üëÅÔ∏è Ver' : '‚úèÔ∏è Editar'}
                                </a>
                                ${d.is_signed ? `
                                    <button class="btn btn-sm btn-secondary" onclick="downloadPDF(${d.id})">
                                        üìÑ PDF
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error loading declarations:', error);
                document.getElementById('declarations-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="color: var(--danger-color);">
                            ‚ùå Error al cargar declaraciones
                        </td>
                    </tr>
                `;
            }
        }
        
        function formatDeclarationType(type) {
            const types = {
                'inicial': 'Inicial',
                'correccion': 'Correcci√≥n'
            };
            return types[type] || type;
        }
        
        async function downloadPDF(declarationId) {
            try {
                showLoading();
                await DeclarationsAPI.downloadPDF(declarationId);
                hideLoading();
            } catch (error) {
                hideLoading();
                alert('Error al descargar PDF: ' + error.message);
            }
        }
        
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('active');
        }
        
        // Logout
        document.getElementById('btn-logout').addEventListener('click', async () => {
            await AuthAPI.logout();
            window.location.href = 'login.html';
        });
        
        // Inicializar
        loadUserData();
        loadDeclarations();
    </script>
</body>
</html>
